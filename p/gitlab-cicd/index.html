<!doctype html><html lang=zh-ch dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ä¸»è¦è®°å½•åœ¨å¼€å‘ä½ä»£ç å¹³å°çš„æ—¶å€™ä½¿ç”¨çš„ Gitlab CI/CD çš„ä¸€äº›åŸºç¡€åŠŸèƒ½"><title>GitLab CI/CD ç®€ä»‹æ–‡æ¡£</title>
<link rel=canonical href=https://cyber-blog.github.io/p/gitlab-cicd/><link rel=stylesheet href=/scss/style.min.70a01615b5dd99826a360296920067f6e3896a41fe397d04d6b849efef75a174.css><meta property='og:title' content="GitLab CI/CD ç®€ä»‹æ–‡æ¡£"><meta property='og:description' content="ä¸»è¦è®°å½•åœ¨å¼€å‘ä½ä»£ç å¹³å°çš„æ—¶å€™ä½¿ç”¨çš„ Gitlab CI/CD çš„ä¸€äº›åŸºç¡€åŠŸèƒ½"><meta property='og:url' content='https://cyber-blog.github.io/p/gitlab-cicd/'><meta property='og:site_name' content='ä»¿ç”Ÿäººä¼šæ¢¦è§ç”µå­ç¾Šå—ï¼Ÿ'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='CI/CD'><meta property='article:published_time' content='2020-11-24T00:00:00+00:00'><meta property='article:modified_time' content='2020-11-24T00:00:00+00:00'><meta property='og:image' content='https://cyber-blog.github.io/p/gitlab-cicd/cover.png'><meta name=twitter:title content="GitLab CI/CD ç®€ä»‹æ–‡æ¡£"><meta name=twitter:description content="ä¸»è¦è®°å½•åœ¨å¼€å‘ä½ä»£ç å¹³å°çš„æ—¶å€™ä½¿ç”¨çš„ Gitlab CI/CD çš„ä¸€äº›åŸºç¡€åŠŸèƒ½"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cyber-blog.github.io/p/gitlab-cicd/cover.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu9062387157319251782.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ«¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>ä»¿ç”Ÿäººä¼šæ¢¦è§ç”µå­ç¾Šå—ï¼Ÿ</a></h1><h2 class=site-description>Do Androids Dream of Electric Sheep?</h2></div></header><ol class=menu-social><li><a href=https://github.com/majiang213 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><ol><li></li></ol></li></ol></li><li><a href=#åŸºæœ¬-cicd-å·¥ä½œæµç¨‹>åŸºæœ¬ CI/CD å·¥ä½œæµç¨‹</a></li></ol><ol><li><a href=#gitlab-runnerå®‰è£…>GitLab Runnerå®‰è£…</a><ol><li><a href=#helmå®‰è£…gitlab-runner>Helmå®‰è£…GitLab Runner</a><ol><li><a href=#å‘gitlab-runneræä¾›è®¿é—®gitlabçš„è‡ªç”Ÿæˆè¯ä¹¦>å‘gitLab Runneræä¾›è®¿é—®gitLabçš„è‡ªç”Ÿæˆè¯ä¹¦</a></li></ol></li><li><a href=#ä½¿ç”¨helm-chartæ›´æ–°gitlab-runner>ä½¿ç”¨Helm Chartæ›´æ–°GitLab Runner</a></li><li><a href=#ä½¿ç”¨helm-chartåˆ é™¤gitlab-runner>ä½¿ç”¨Helm Chartåˆ é™¤GitLab Runner</a></li></ol></li><li><a href=#ç¦»çº¿å®‰è£…gitlab-runner>ç¦»çº¿å®‰è£…Gitlab-runner</a></li><li><a href=#gitlab-runnerå®‰è£…å½“ä¸­éœ€è¦æ³¨æ„çš„é—®é¢˜>gitlab-runnerå®‰è£…å½“ä¸­éœ€è¦æ³¨æ„çš„é—®é¢˜</a><ol><li><a href=#kubernetesé›†ç¾¤æœ‰æ±¡ç‚¹å¯¼è‡´æ‰§è¡Œå™¨æ— æ³•å¯åŠ¨çš„é—®é¢˜åŠè§£å†³åŠæ³•>kubernetesé›†ç¾¤æœ‰æ±¡ç‚¹å¯¼è‡´æ‰§è¡Œå™¨æ— æ³•å¯åŠ¨çš„é—®é¢˜åŠè§£å†³åŠæ³•</a><ol><li><a href=#è§£å†³æ–¹æ¡ˆ>è§£å†³æ–¹æ¡ˆ</a></li></ol></li><li><a href=#å…³äºhelmå®‰è£…çš„gitlab-runneræ‰€å¯åŠ¨çš„æ‰§è¡Œå™¨ç»å¸¸å› ä¸ºcould-not-resolve-hostgitdomaincomæŠ¥é”™çš„é—®é¢˜>å…³äºHelmå®‰è£…çš„gitlab-runneræ‰€å¯åŠ¨çš„æ‰§è¡Œå™¨ç»å¸¸å› ä¸ºCould not resolve host:git.domain.comæŠ¥é”™çš„é—®é¢˜</a></li><li><a href=#åœ¨å®¹å™¨ä¸­æ„å»ºæ—¶ä½¿ç”¨docker>åœ¨å®¹å™¨ä¸­æ„å»ºæ—¶ä½¿ç”¨docker</a></li><li><a href=#ç¼“å­˜ç›¸å…³é…ç½®>ç¼“å­˜ç›¸å…³é…ç½®</a></li><li><a href=#gitlab-runner-éƒ¨ç½²åˆ°k8sæ—¶æŠ¥é”™deploymentextensions-demo-is-forbidden-user-systemserviceaccountgitlabdefault-cannot-get-resource-deployments-in-api-group-extensions-in-the-namespace-default>gitlab-runner éƒ¨ç½²åˆ°k8sæ—¶æŠ¥é”™:deployment.extensions demo is forbidden: user &ldquo;system:serviceaccount:gitlab:default&rdquo; cannot get resource deployments in api group extensions in the namespace default</a></li></ol></li><li><a href=#gitlab-cicd-çš„ä½¿ç”¨æ–‡æ¡£>GitLab CI/CD çš„ä½¿ç”¨æ–‡æ¡£</a><ol><li><a href=#gitlab-ciyml>.gitlab-ci.yml</a><ol><li><a href=#job>job</a></li><li><a href=#stages>stages</a></li><li><a href=#stage>stage</a></li><li><a href=#variables>variables</a></li><li><a href=#workflow>workflow</a></li><li><a href=#cache>cache</a></li><li><a href=#include>include</a></li><li><a href=#image>image</a></li><li><a href=#services>services</a></li><li><a href=#trigger>trigger</a></li><li><a href=#environment>environment</a></li></ol></li><li><a href=#å®æˆ˜gitlab-cicd-è‡ªåŠ¨åŒ–éƒ¨ç½²æ¨é€åˆ°harbor>å®æˆ˜:GitLab CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²æ¨é€åˆ°Harbor</a></li></ol></li></ol><ol><li><a href=#sonarqubeçš„å®‰è£…>SonarQubeçš„å®‰è£…</a></li><li><a href=#sonarqubeæ•´åˆgitlab-cicd-åˆ†æjavaä»£ç >SonarQubeæ•´åˆgitlab CI/CD åˆ†æJavaä»£ç </a></li><li><a href=#åœ¨gitlab-cicdä½¿ç”¨å½“ä¸­é‡åˆ°çš„é—®é¢˜>åœ¨gitlab CI/CDä½¿ç”¨å½“ä¸­é‡åˆ°çš„é—®é¢˜</a><ol><li><a href=#triggerè§¦å‘å™¨ä¸èƒ½ä½¿ç”¨å˜é‡å»å®šä¹‰>triggerè§¦å‘å™¨ä¸èƒ½ä½¿ç”¨å˜é‡å»å®šä¹‰</a></li><li><a href=#åœ¨åŒä¸€ä¸ªæµæ°´çº¿å½“ä¸­çš„jobä¹‹é—´å˜é‡æ— æ³•ä¼ é€’>åœ¨åŒä¸€ä¸ªæµæ°´çº¿å½“ä¸­çš„jobä¹‹é—´å˜é‡æ— æ³•ä¼ é€’</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/gitlab-cicd/><img src=/p/gitlab-cicd/cover_hu18325665342398267168.png srcset="/p/gitlab-cicd/cover_hu18325665342398267168.png 800w, /p/gitlab-cicd/cover_hu7400773267739852289.png 1600w" width=800 height=420 loading=lazy alt="Featured image of post GitLab CI/CD ç®€ä»‹æ–‡æ¡£"></a></div><div class=article-details><header class=article-category><a href=/categories/tech/ style=background-color:#2a9d8f;color:#fff>æŠ€æœ¯åšå®¢</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/gitlab-cicd/>GitLab CI/CD ç®€ä»‹æ–‡æ¡£</a></h2><h3 class=article-subtitle>ä¸»è¦è®°å½•åœ¨å¼€å‘ä½ä»£ç å¹³å°çš„æ—¶å€™ä½¿ç”¨çš„ Gitlab CI/CD çš„ä¸€äº›åŸºç¡€åŠŸèƒ½</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 24, 2020</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 21 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><p>GitLab CI/CD æ˜¯ä¸€ä¸ªå†…ç½®åœ¨GitLabä¸­çš„å·¥å…·ï¼Œç”¨äºé€šè¿‡æŒç»­æ–¹æ³•è¿›è¡Œè½¯ä»¶å¼€å‘ï¼š</p><ul><li>Continuous Integration (CI) æŒç»­é›†æˆ</li><li>Continuous Delivery (CD) æŒç»­äº¤ä»˜</li><li>Continuous Deployment (CD) æŒç»­éƒ¨ç½²</li></ul><p>æŒç»­é›†æˆçš„å·¥ä½œåŸç†æ˜¯å°†å°çš„ä»£ç å—æ¨é€åˆ°Gitä»“åº“ä¸­æ‰˜ç®¡çš„åº”ç”¨ç¨‹åºä»£ç åº“ä¸­ï¼Œå¹¶ä¸”æ¯æ¬¡æ¨é€æ—¶ï¼Œéƒ½è¦è¿è¡Œä¸€ç³»åˆ—è„šæœ¬æ¥æ„å»ºã€æµ‹è¯•å’ŒéªŒè¯ä»£ç æ›´æ”¹ï¼Œç„¶åå†å°†å…¶åˆå¹¶åˆ°ä¸»åˆ†æ”¯ä¸­ã€‚</p><p>æŒç»­äº¤ä»˜å’Œéƒ¨ç½²ç›¸å½“äºæ›´è¿›ä¸€æ­¥çš„CIï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ¨é€åˆ°ä»“åº“é»˜è®¤åˆ†æ”¯çš„åŒæ—¶å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚</p><p>è¿™äº›æ–¹æ³•ä½¿å¾—å¯ä»¥åœ¨å¼€å‘å‘¨æœŸçš„æ—©æœŸå‘ç°bugså’Œerrorsï¼Œä»è€Œç¡®ä¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒçš„æ‰€æœ‰ä»£ç éƒ½ç¬¦åˆä¸ºåº”ç”¨ç¨‹åºå»ºç«‹çš„ä»£ç æ ‡å‡†ã€‚</p><p>GitLab CI/CD ç”±ä¸€ä¸ªåä¸º .gitlab-ci.yml çš„æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œæ”¹æ–‡ä»¶ä½äºä»“åº“çš„æ ¹ç›®å½•ä¸‹ã€‚æ–‡ä»¶ä¸­æŒ‡å®šçš„è„šæœ¬ç”±GitLab Runneræ‰§è¡Œã€‚</p><p>å®ƒæ¶‰åŠåˆ°åœ¨æ¯æ¬¡å°çš„è¿­ä»£ä¸­å°±ä¸æ–­åœ°æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²ä»£ç æ›´æ”¹ï¼Œä»è€Œå‡å°‘äº†åŸºäºå·²ç»å­˜åœ¨bugæˆ–å¤±è´¥çš„å…ˆå‰ç‰ˆæœ¬å¼€å‘æ–°ä»£ç çš„æœºä¼šã€‚</p><h6 id=continuous-integrationæŒç»­é›†æˆ>Continuous Integrationï¼ˆæŒç»­é›†æˆï¼‰</h6><p>å‡è®¾ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå…¶ä»£ç å­˜å‚¨åœ¨GitLabçš„Gitä»“åº“ä¸­ã€‚å¼€å‘äººå‘˜æ¯å¤©éƒ½è¦å¤šæ¬¡æ¨é€ä»£ç æ›´æ”¹ã€‚å¯¹äºæ¯æ¬¡å‘ä»“åº“çš„æ¨é€ï¼Œä½ éƒ½å¯ä»¥åˆ›å»ºä¸€ç»„è„šæœ¬æ¥è‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•ä½ çš„åº”ç”¨ç¨‹åºï¼Œä»è€Œå‡å°‘äº†å‘åº”ç”¨ç¨‹åºå¼•å…¥é”™è¯¯çš„æœºä¼šã€‚è¿™ç§åšæ³•ç§°ä¸ºæŒç»­é›†æˆï¼Œå¯¹äºæäº¤ç»™åº”ç”¨ç¨‹åºï¼ˆç”šè‡³æ˜¯å¼€å‘åˆ†æ”¯ï¼‰çš„æ¯é¡¹æ›´æ”¹ï¼Œå®ƒéƒ½ä¼šè‡ªåŠ¨è¿ç»­è¿›è¡Œæ„å»ºå’Œæµ‹è¯•ï¼Œä»¥ç¡®ä¿æ‰€å¼•å…¥çš„æ›´æ”¹é€šè¿‡ä½ ä¸ºåº”ç”¨ç¨‹åºå»ºç«‹çš„æ‰€æœ‰æµ‹è¯•ï¼Œå‡†åˆ™å’Œä»£ç åˆè§„æ€§æ ‡å‡†ã€‚</p><h6 id=continuous-deliveryæŒç»­äº¤ä»˜>Continuous Deliveryï¼ˆæŒç»­äº¤ä»˜ï¼‰</h6><p>æŒç»­äº¤ä»˜æ˜¯è¶…è¶ŠæŒç»­é›†æˆçš„æ›´è¿›ä¸€æ­¥çš„æ“ä½œã€‚åº”ç”¨ç¨‹åºä¸ä»…ä¼šåœ¨æ¨é€åˆ°ä»£ç åº“çš„æ¯æ¬¡ä»£ç æ›´æ”¹æ—¶è¿›è¡Œæ„å»ºå’Œæµ‹è¯•ï¼Œè€Œä¸”ï¼Œå°½ç®¡éƒ¨ç½²æ˜¯æ‰‹åŠ¨è§¦å‘çš„ï¼Œä½†ä½œä¸ºä¸€ä¸ªé™„åŠ æ­¥éª¤ï¼Œå®ƒä¹Ÿå¯ä»¥è¿ç»­éƒ¨ç½²ã€‚æ­¤æ–¹æ³•å¯ç¡®ä¿è‡ªåŠ¨æ£€æŸ¥ä»£ç ï¼Œä½†éœ€è¦äººå·¥å¹²é¢„æ‰èƒ½ä»ç­–ç•¥ä¸Šæ‰‹åŠ¨è§¦å‘ä»¥å¿…è¾“æ­¤æ¬¡å˜æ›´ã€‚</p><h6 id=continuous-deploymentæŒç»­éƒ¨ç½²>Continuous Deploymentï¼ˆæŒç»­éƒ¨ç½²ï¼‰</h6><p>ä¸æŒç»­äº¤ä»˜ç±»ä¼¼ï¼Œä½†ä¸åŒä¹‹å¤„åœ¨äºï¼Œä½ æ— éœ€å°†å…¶æ‰‹åŠ¨éƒ¨ç½²ï¼Œè€Œæ˜¯å°†å…¶è®¾ç½®ä¸ºè‡ªåŠ¨éƒ¨ç½²ã€‚å®Œå…¨ä¸éœ€è¦äººå·¥å¹²é¢„å³å¯éƒ¨ç½²ä½ çš„åº”ç”¨ç¨‹åºã€‚</p><h2 id=åŸºæœ¬-cicd-å·¥ä½œæµç¨‹>åŸºæœ¬ CI/CD å·¥ä½œæµç¨‹</h2><p>ä¸€æ—¦ä½ å°†æäº¤æ¨é€åˆ°è¿œç¨‹ä»“åº“çš„åˆ†æ”¯ä¸Šï¼Œé‚£ä¹ˆä½ ä¸ºè¯¥é¡¹ç›®è®¾ç½®çš„CI/CDç®¡é“å°†ä¼šè¢«è§¦å‘ã€‚GitLab CI/CD çš„æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=/p/gitlab-cicd/874963-20200203190921731-1402877301.png width=3420 height=1894 srcset="/p/gitlab-cicd/874963-20200203190921731-1402877301_hu12168210532367399422.png 480w, /p/gitlab-cicd/874963-20200203190921731-1402877301_hu5430032919100052470.png 1024w" loading=lazy class=gallery-image data-flex-grow=180 data-flex-basis=433px></p><p>é€šè¿‡GitLab UIæ‰€æœ‰çš„æ­¥éª¤éƒ½æ˜¯å¯è§†åŒ–çš„ã€‚</p><p>æ·±å…¥ç ”ç©¶åŸºæœ¬å·¥ä½œæµç¨‹ï¼Œåˆ™å¯ä»¥åœ¨DevOpsç”Ÿå‘½å‘¨æœŸçš„æ¯ä¸ªé˜¶æ®µçœ‹åˆ°GitLabä¸­å¯ç”¨çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=/p/gitlab-cicd/874963-20200203191024392-1340530589.png width=1692 height=1068 srcset="/p/gitlab-cicd/874963-20200203191024392-1340530589_hu3260952447508086692.png 480w, /p/gitlab-cicd/874963-20200203191024392-1340530589_hu11559031171706186631.png 1024w" loading=lazy class=gallery-image data-flex-grow=158 data-flex-basis=380px></p><ol><li>Verify</li></ol><ul><li>é€šè¿‡æŒç»­é›†æˆè‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•ä½ çš„åº”ç”¨ç¨‹åº</li><li>ä½¿ç”¨GitLabä»£ç è´¨é‡ï¼ˆGitLab Code Qualityï¼‰åˆ†æä½ çš„æºä»£ç è´¨é‡</li><li>é€šè¿‡æµè§ˆå™¨æ€§èƒ½æµ‹è¯•ï¼ˆBrowser Performance Testingï¼‰ç¡®å®šä»£ç æ›´æ”¹å¯¹æ€§èƒ½çš„å½±å“</li><li>æ‰§è¡Œä¸€ç³»åˆ—æµ‹è¯•ï¼Œæ¯”å¦‚Container Scanning , Dependency Scanning , JUnit tests</li><li>ç”¨Review Appséƒ¨ç½²æ›´æ”¹ï¼Œä»¥é¢„è§ˆæ¯ä¸ªåˆ†æ”¯ä¸Šçš„åº”ç”¨ç¨‹åºæ›´æ”¹</li></ul><ol start=2><li>Package</li></ol><ul><li>ç”¨Container Registryå­˜å‚¨Dockeré•œåƒ</li><li>ç”¨NPM Registryå­˜å‚¨NPMåŒ…</li><li>ç”¨Maven Repositoryå­˜å‚¨Maven artifacts</li><li>ç”¨Conan Repositoryå­˜å‚¨ConanåŒ…</li></ul><ol start=3><li>Release</li></ol><ul><li>æŒç»­éƒ¨ç½²ï¼Œè‡ªåŠ¨å°†ä½ çš„åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ</li><li>æŒç»­äº¤ä»˜ï¼Œæ‰‹åŠ¨ç‚¹å‡»ä»¥å°†ä½ çš„åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ</li><li>ç”¨GitLab Pageséƒ¨ç½²é™æ€ç½‘ç«™</li><li>ä»…å°†åŠŸèƒ½éƒ¨ç½²åˆ°ä¸€ä¸ªPodä¸Šï¼Œå¹¶è®©ä¸€å®šæ¯”ä¾‹çš„ç”¨æˆ·ç¾¤é€šè¿‡Canary Deploymentsè®¿é—®ä¸´æ—¶éƒ¨ç½²çš„åŠŸèƒ½ï¼ˆPSï¼šå³ç°åº¦å‘å¸ƒï¼‰</li><li>åœ¨Feature Flagsä¹‹åéƒ¨ç½²åŠŸèƒ½</li><li>ç”¨GitLab Releaseså°†å‘å¸ƒè¯´æ˜æ·»åŠ åˆ°ä»»æ„Git tag</li><li>ä½¿ç”¨Deploy BoardsæŸ¥çœ‹åœ¨Kubernetesä¸Šè¿è¡Œçš„æ¯ä¸ªCIç¯å¢ƒçš„å½“å‰è¿è¡ŒçŠ¶å†µå’ŒçŠ¶æ€</li><li>ä½¿ç”¨Auto Deployå°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­çš„ç”Ÿäº§ç¯å¢ƒ</li></ul><p>ä½¿ç”¨GitLab CI/CDï¼Œè¿˜å¯ä»¥ï¼š</p><ul><li>é€šè¿‡Auto DevOpsè½»æ¾è®¾ç½®åº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ</li><li>å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒ</li><li>å®‰è£…ä½ è‡ªå·±çš„GitLab Runner</li><li>Schedule pipelines</li><li>ä½¿ç”¨å®‰å…¨æµ‹è¯•æŠ¥å‘Šï¼ˆSecurity Test reportsï¼‰æ£€æŸ¥åº”ç”¨ç¨‹åºæ¼æ´</li></ul><h1 id=gitlab-runner>GitLab Runner</h1><ol><li>GitLab-CI
â€ƒGitLab-CIå°±æ˜¯ä¸€å¥—é…åˆGitLabä½¿ç”¨çš„æŒç»­é›†æˆç³»ç»Ÿï¼ˆå½“ç„¶ï¼Œè¿˜æœ‰å…¶å®ƒçš„æŒç»­é›†æˆç³»ç»Ÿï¼ŒåŒæ ·å¯ä»¥é…åˆGitLabä½¿ç”¨ï¼Œæ¯”å¦‚Jenkinsï¼‰ã€‚è€Œä¸”GitLab8.0ä»¥åçš„ç‰ˆæœ¬æ˜¯é»˜è®¤é›†æˆäº†GitLab-CIå¹¶ä¸”é»˜è®¤å¯ç”¨çš„ã€‚</li><li>GitLab-Runner
â€ƒGitLab-Runneræ˜¯é…åˆGitLab-CIè¿›è¡Œä½¿ç”¨çš„ã€‚GitLabé‡Œé¢çš„æ¯ä¸€ä¸ªå·¥ç¨‹éƒ½ä¼šå®šä¹‰ä¸€ä¸ªå±äºè¿™ä¸ªå·¥ç¨‹çš„è½¯ä»¶é›†æˆè„šæœ¬ï¼Œç”¨æ¥è‡ªåŠ¨åŒ–åœ°å®Œæˆä¸€äº›è½¯ä»¶é›†æˆå·¥ä½œã€‚å½“è¿™ä¸ªå·¥ç¨‹çš„ä»“åº“ä»£ç å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œæ¯”å¦‚æœ‰äººpushäº†ä»£ç ï¼ŒGitLabå°±ä¼šå°†è¿™ä¸ªå˜åŠ¨é€šçŸ¥GitLab-CIã€‚è¿™æ—¶GitLab-CIä¼šæ‰¾å‡ºä¸è¿™ä¸ªå·¥ç¨‹ç›¸å…³è”çš„Runnerï¼Œå¹¶é€šçŸ¥è¿™äº›RunneræŠŠä»£ç æ›´æ–°åˆ°æœ¬åœ°å¹¶æ‰§è¡Œé¢„å®šä¹‰å¥½çš„æ‰§è¡Œè„šæœ¬ã€‚
â€ƒæ‰€ä»¥ï¼ŒGitLab-Runnerå°±æ˜¯ä¸€ä¸ªç”¨æ¥æ‰§è¡Œè½¯ä»¶é›†æˆè„šæœ¬çš„ä¸œè¥¿ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼šRunnerå°±åƒä¸€ä¸ªä¸ªçš„å·¥äººï¼Œè€ŒGitLab-CIå°±æ˜¯è¿™äº›å·¥äººçš„ä¸€ä¸ªç®¡ç†ä¸­å¿ƒï¼Œæ‰€æœ‰å·¥äººéƒ½è¦åœ¨GitLab-CIé‡Œé¢ç™»è®°æ³¨å†Œï¼Œå¹¶ä¸”è¡¨æ˜è‡ªå·±æ˜¯ä¸ºå“ªä¸ªå·¥ç¨‹æœåŠ¡çš„ã€‚å½“ç›¸åº”çš„å·¥ç¨‹å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒGitLab-CIå°±ä¼šé€šçŸ¥ç›¸åº”çš„å·¥äººæ‰§è¡Œè½¯ä»¶é›†æˆè„šæœ¬ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li></ol><p><img src=/p/gitlab-cicd/20190325191119620.png width=773 height=606 srcset="/p/gitlab-cicd/20190325191119620_hu9327950469716357547.png 480w, /p/gitlab-cicd/20190325191119620_hu11881963875153611974.png 1024w" loading=lazy class=gallery-image data-flex-grow=127 data-flex-basis=306px></p><p>â€‹ GitLab-Runnerå¯ä»¥åˆ†ç±»ä¸‰ç§ç±»å‹ï¼šShared ï¼ˆå…±äº«ï¼‰ã€Groupï¼ˆç»„ç§æœ‰ï¼‰ã€Specific ï¼ˆåº“ç§æœ‰ï¼‰ã€‚
â€ƒâ€ƒ Sharedï¼šè¿™ç§Runneræ˜¯æ‰€æœ‰å·¥ç¨‹éƒ½èƒ½å¤Ÿç”¨çš„ã€‚åªæœ‰ç³»ç»Ÿç®¡ç†å‘˜èƒ½å¤Ÿåˆ›å»ºSharedç±»å‹çš„Runnerã€‚</p><p>â€‹ Groupï¼šæŒ‡å®šç»„ç§æœ‰çš„runnerï¼Œéœ€è¦æœ‰ç»„å¯¹åº”çš„æƒé™ã€‚</p><p>â€ƒâ€ƒ Specificï¼šè¿™ç§Runneråªèƒ½ä¸ºæŒ‡å®šçš„å·¥ç¨‹æœåŠ¡ã€‚æ‹¥æœ‰è¯¥å·¥ç¨‹è®¿é—®æƒé™çš„äººéƒ½èƒ½å¤Ÿä¸ºè¯¥å·¥ç¨‹åˆ›å»ºSharedç±»å‹çš„runnerã€‚</p><h2 id=gitlab-runnerå®‰è£…>GitLab Runnerå®‰è£…</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ„å»ºä»»åŠ¡éƒ½ä¼šå ç”¨å¾ˆå¤šçš„ç³»ç»Ÿèµ„æº (å¦‚ç¼–è¯‘ä»£ç )ï¼Œè€Œ GitLab CI åˆæ˜¯ GitLab çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚æœç”± GitLab CI æ¥è¿è¡Œæ„å»ºä»»åŠ¡çš„è¯ï¼Œåœ¨æ‰§è¡Œæ„å»ºä»»åŠ¡çš„æ—¶å€™ï¼ŒGitLab çš„æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ã€‚</p><p>æ‰€ä»¥GitLab Runnerå¯ä»¥å®‰è£…åˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œæ‰€ä»¥åœ¨æ„å»ºä»»åŠ¡è¿è¡ŒæœŸé—´å¹¶ä¸ä¼šå½±å“åˆ° GitLab çš„æ€§èƒ½ã€‚</p><p>å…³äºGitLab Runnerçš„å®‰è£…åŸºæœ¬ä¸Šåˆ†ä¸ºä¸‰ç§æ–¹å¼:</p><ul><li>ç›´æ¥å®‰è£…åœ¨ç‰©ç†æœºå½“ä¸­</li><li>å®‰è£…åœ¨Dockerå®¹å™¨å½“ä¸­</li><li>é€šè¿‡Helmå®‰è£…åœ¨Kubernetesé›†ç¾¤å½“ä¸­</li></ul><h3 id=helmå®‰è£…gitlab-runner>Helmå®‰è£…GitLab Runner</h3><p>æ·»åŠ  GitLab Helm å­˜å‚¨åº“:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm repo add gitlab https://charts.gitlab.io
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å¦‚æœä½¿ç”¨ Helm 2ï¼Œä½ å¿…é¡»åˆå§‹åŒ– Helm:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm init
</span></span></code></pre></td></tr></table></div></div></blockquote><p>é…ç½®GitLab Runnerå®‰è£…æ‰€éœ€çš„é…ç½®æ–‡ä»¶<code>values.yaml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## Specify a imagePullPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## The GitLab Server URL (with protocol) that want to register the runner against</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://docs.gitlab.com/runner/commands/README.html#gitlab-runner-register</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>gitlabUrl</span><span class=p>:</span><span class=w> </span><span class=l>https://gitlab.example.com/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## The registration token for adding new Runners to the GitLab server. This must</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## be retrieved from your GitLab instance.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://docs.gitlab.com/ee/ci/runners/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>runnerRegistrationToken</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Set the certsSecretName in order to pass custom certificates for GitLab Runner to use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Provide resource name for a Kubernetes Secret Object in the same namespace,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## this is used to populate the /etc/gitlab-runner/certs directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## å¦‚æœGitLabä½¿ç”¨äº†è‡ªç­¾åçš„sslè¯ä¹¦åˆ™éœ€è¦æŒ‡å®šsecretï¼Œè¯¦æƒ…è§ä¸‹ä¸€å°èŠ‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#certsSecretName:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Configure the maximum number of concurrent jobs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>concurrent</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Defines in seconds how often to check GitLab for a new builds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>checkInterval</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## For RBAC support:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## create ä¸ºfalseåˆ™ä¸é»˜è®¤åˆ›å»ºè´¦æˆ·ï¼Œæ¨èè‡ªåŠ¨åˆ›å»º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rbac</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>create</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>your-service-account</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Run the gitlab-bastion container with the ability to deploy/manage containers of jobs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## cluster-wide or only within namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterWideAccess</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## If RBAC is disabled in this Helm chart, use the following Kubernetes Service Account name.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># serviceAccountName: default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Configuration for the Pods that the runner launches for each new job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>runners</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Default container image to use for builds when none is specified</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu:20.04</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Configuration for the Pods that that the runner launches for each new job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      [[runners]]
</span></span></span><span class=line><span class=cl><span class=sd>          pre_clone_script = &#34;echo &#39;10.10.10.224 git.netstar.com&#39; &gt;&gt; /etc/hosts&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          [runners.kubernetes]
</span></span></span><span class=line><span class=cl><span class=sd>            helper_image = &#34;harbor.wangxingcloud.com/system/gitlab-runner-helper:x86_64-e95f89a0&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            image = &#34;ubuntu:20.04&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            privileged = true
</span></span></span><span class=line><span class=cl><span class=sd>          [[runners.kubernetes.volumes.empty_dir]]
</span></span></span><span class=line><span class=cl><span class=sd>            name = &#34;docker-certs&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            mount_path = &#34;/certs/client&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            medium = &#34;Memory&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          [[runners.kubernetes.volumes.host_path]]
</span></span></span><span class=line><span class=cl><span class=sd>            name = &#34;docker&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            mount_path = &#34;/var/run/docker.sock&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            read_only = true
</span></span></span><span class=line><span class=cl><span class=sd>            host_path = &#34;/var/run/docker.sock&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            </span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Run all containers with the privileged flag enabled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## This will allow the docker:stable-dind image to run if you need to run Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## commands. Please read the docs before turning this on:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Namespace to run Kubernetes jobs in (defaults to &#39;default&#39;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># namespace:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Build Container specific configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>builds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># cpuLimit: 200m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># memoryLimit: 256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpuRequests</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memoryRequests</span><span class=p>:</span><span class=w> </span><span class=l>128Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Service Container specific configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># cpuLimit: 200m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># memoryLimit: 256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpuRequests</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memoryRequests</span><span class=p>:</span><span class=w> </span><span class=l>128Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Helper Container specific configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>helpers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># cpuLimit: 200m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># memoryLimit: 256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpuRequests</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memoryRequests</span><span class=p>:</span><span class=w> </span><span class=l>128Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Affinity for pod assignment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ä¸»æœºè°ƒåº¦-äº²å’Œæ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>affinity</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/os</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>linux</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>values.yamlå…¨éƒ¨é…ç½®å‚æ•°è¯¦æƒ…æŸ¥çœ‹:</p><p><a class=link href=https://gitlab.com/gitlab-org/charts/gitlab-runner/blob/master/values.yaml target=_blank rel=noopener>https://gitlab.com/gitlab-org/charts/gitlab-runner/blob/master/values.yaml</a></p></blockquote><p>é…ç½®æ–‡ä»¶ä¿å­˜åè¾“å…¥å¦‚ä¸‹å‘½ä»¤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># For Helm 2</span>
</span></span><span class=line><span class=cl>helm install --namespace &lt;NAMESPACE&gt; --name gitlab-runner -f &lt;CONFIG_VALUES_FILE&gt; gitlab/gitlab-runner
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># For Helm 3</span>
</span></span><span class=line><span class=cl>helm install --namespace &lt;NAMESPACE&gt; gitlab-runner -f &lt;CONFIG_VALUES_FILE&gt; gitlab/gitlab-runner
</span></span></code></pre></td></tr></table></div></div><blockquote><ul><li><p><code>&lt;NAMESPACE></code> æ˜¯ä½ æƒ³è¦å®‰è£… GitLab Runner çš„ Kubernetes åç§°ç©ºé—´</p><ul><li>è¿è¡Œ<code>kubectl create namespace &lt;NAMESPACE></code> åˆ›å»ºæ–°çš„å‘½åç©ºé—´</li></ul></li><li><p><code>&lt;CONFIG_VALUES_FILE></code> æ˜¯åŒ…å«è‡ªå®šä¹‰é…ç½®çš„å€¼æ–‡ä»¶çš„è·¯å¾„ã€‚å‚è§<a class=link href=https://docs.gitlab.com/runner/install/kubernetes.html#configuring-gitlab-runner-using-the-helm-chart target=_blank rel=noopener> ä½¿ç”¨ Helm Chart é…ç½® GitLab Runner</a> æ¥åˆ›å»ºå®ƒ</p></li><li><p>å€¼å¾—æ³¨æ„çš„æ˜¯é…ç½®æ–‡ä»¶çš„ç¬¬ä¸‰é¡¹ï¼Œå¦‚æœGitLabä½¿ç”¨çš„æ˜¯è‡ªç”Ÿæˆçš„è¯ä¹¦åˆ™éœ€è¦é…ç½®<code>certsSecretName</code>çš„å€¼ï¼Œé…ç½®å€¼ä¸ºåŒä¸€å‘½åç©ºé—´çš„Kubernetes secretçš„å€¼</p></li><li><p>è¿è¡Œrunnerçš„æ—¶å€™æŠ¥é”™<code>ERROR: Job failed (system failure): secrets is forbidden: User "system:serviceaccount:gitlab:default" cannot create resource "secrets" in API group "" in the namespace "gitlab"</code>åŸå› æ˜¯æ²¡æœ‰ç‰¹åˆ«æŒ‡å®šserviceaccount é‚£ä¹ˆå°†ä½¿ç”¨é»˜è®¤è´¦æˆ· system:serviceaccount:<namespace>:default
æœ€ç»ˆçš„åŸå› å°±æ˜¯æ²¡æœ‰åˆ›å»º å¯¹åº” namespaces çš„ é›†ç¾¤è§’è‰²ç»‘å®š<code>clusterrolebinding</code>
æ‰§è¡Œå‘½ä»¤ï¼Œåˆ›å»º<code>clusterrolebinding</code>è§£å†³</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create clusterrolebinding gitlab-cluster-admin --clusterrole<span class=o>=</span>cluster-admin --group<span class=o>=</span>system:serviceaccounts --namespace<span class=o>=</span>&lt;NAMESPACE&gt;
</span></span></code></pre></td></tr></table></div></div></li></ul></blockquote><h4 id=å‘gitlab-runneræä¾›è®¿é—®gitlabçš„è‡ªç”Ÿæˆè¯ä¹¦>å‘gitLab Runneræä¾›è®¿é—®gitLabçš„è‡ªç”Ÿæˆè¯ä¹¦</h4><p>éœ€è¦å‘ GitLab Runner Helm Chart é…ç½®æ–‡ä»¶æä¾›ä¸€ä¸ª Kubernetes Secretï¼Œå®ƒå°†ä¼šæŒ‚è½½åœ¨å®¹å™¨çš„ <code>/etc/GitLab-Runner/certs</code>ç›®å½•ã€‚</p><p>è¿è¡Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºKubernetes secret</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl
</span></span><span class=line><span class=cl>  --namespace &lt;NAMESPACE&gt;
</span></span><span class=line><span class=cl>  create secret generic &lt;SECRET_NAME&gt;
</span></span><span class=line><span class=cl>  --from-file<span class=o>=</span>&lt;CERTIFICATE_FILENAME&gt;
</span></span></code></pre></td></tr></table></div></div><blockquote><ul><li>ä½¿ç”¨<code>.crt</code>ç»“å°¾çš„æ–‡ä»¶å¿…é¡»ä¸º<code>gitlab.your-domain.com.crt</code>çš„å›ºå®šæ ¼å¼</li><li><code>SECRET_NAME</code> Kubernetes çš„èµ„æºåç§°(ä¾‹å¦‚:<code>gitlab-domain-cert</code>)</li><li><code>&lt;CERTIFICATE_FILENAME></code>.crtç»“å°¾çš„è¯ä¹¦æ–‡ä»¶</li><li>å¦‚æœæºæ–‡ä»¶<code> &lt;CERTIFICATE_FILENAME></code> ä¸éµå¾ª <code>&lt;gitlab-hostname.crt></code> æ ¼å¼ï¼Œé‚£ä¹ˆæœ‰å¿…è¦æŒ‡å®šåœ¨ç›®æ ‡æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ–‡ä»¶å:</li></ul></blockquote><p>æœ€ååœ¨<code>values.yaml</code>é…ç½®æ–‡ä»¶ä¸­é…ç½®secretçš„åç§°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## Set the certsSecretName in order to pass custom certificates for GitLab Runner to use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Provide resource name for a Kubernetes Secret Object in the same namespace,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## this is used to populate the /etc/gitlab-runner/certs directory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>certsSecretName</span><span class=p>:</span><span class=w> </span><span class=l>&lt;SECRET NAME&gt;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a class=link href=https://docs.gitlab.com/runner/install/kubernetes.html#providing-a-custom-certificate-for-accessing-gitlab target=_blank rel=noopener>https://docs.gitlab.com/runner/install/kubernetes.html#providing-a-custom-certificate-for-accessing-gitlab</a></p></blockquote><h3 id=ä½¿ç”¨helm-chartæ›´æ–°gitlab-runner>ä½¿ç”¨Helm Chartæ›´æ–°GitLab Runner</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm upgrade --namespace &lt;NAMESPACE&gt; -f &lt;CONFIG_VALUES_FILE&gt; &lt;RELEASE-NAME&gt; gitlab/gitlab-runner
</span></span></code></pre></td></tr></table></div></div><blockquote><ul><li><p><code>&lt;RELEASE-NAME></code>æ˜¯ä½ åœ¨å®‰è£…GitLab Runneræ—¶ç»™å‡ºçš„åå­—ï¼Œå‚è€ƒ<a class=link href=https://docs.gitlab.com/runner/install/kubernetes.html#installing-gitlab-runner-using-the-helm-chart target=_blank rel=noopener> ä½¿ç”¨Helmå®‰è£… GitLab Runner</a> æ—¶ä½¿ç”¨çš„æ˜¯<code>gitlab-runner</code>ã€‚</p></li><li><p>å¦‚æœä½ æƒ³æ›´æ–°åˆ° GitLab Runner Helm Chart çš„ç‰¹å®šç‰ˆæœ¬è€Œä¸æ˜¯æœ€æ–°çš„ç‰ˆæœ¬ï¼Œåœ¨ä½ çš„ Helm upgrade å‘½ä»¤ä¸­æ·»åŠ å‚æ•°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>-version &lt; Runner Helm Chart version &gt;
</span></span></code></pre></td></tr></table></div></div></li></ul></blockquote><h3 id=ä½¿ç”¨helm-chartåˆ é™¤gitlab-runner>ä½¿ç”¨Helm Chartåˆ é™¤GitLab Runner</h3><p>è¦å¸è½½ GitLab Runner Chartï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm delete --namespace &lt;NAMESPACE&gt; &lt;RELEASE-NAME&gt;
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a class=link href=https://docs.gitlab.com/runner/install/kubernetes.html#required-configuration target=_blank rel=noopener>https://docs.gitlab.com/runner/install/kubernetes.html#required-configuration</a></p></blockquote><h2 id=ç¦»çº¿å®‰è£…gitlab-runner>ç¦»çº¿å®‰è£…Gitlab-runner</h2><p>ç¦»çº¿ç¯å¢ƒä½¿ç”¨helmå®‰è£…gitlab-runnerã€‚éœ€è¦å…ˆå°†æ‰€éœ€çš„dockeré•œåƒå¯¼å…¥åˆ°ç¦»çº¿ç¯å¢ƒçš„harborä¸­ã€‚</p><p>åœ¨æœ‰ç½‘ç»œçš„ç¯å¢ƒï¼Œè¿è¡Œä¸‹é¢å‘½ä»¤ç”Ÿæˆk8sèµ„æºçš„ymlæ–‡ä»¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm template --namespace &lt;NAMESPACE&gt; gitlab-runner -f &lt;CONFIG_VALUES_FILE&gt; gitlab/gitlab-runner &gt; values.yaml
</span></span></code></pre></td></tr></table></div></div><p>è®²ç”Ÿæˆçš„ymlæ–‡ä»¶å¤åˆ¶åˆ°è¦ç¦»çº¿å®‰è£…çš„k8sç¯å¢ƒåï¼Œè¿è¡Œ<code>kubectl apply -f values.yaml</code>å‘½ä»¤</p><blockquote><ul><li><p>ç›®å‰ç”Ÿæˆçš„<code>template.yaml</code>æ–‡ä»¶ä¸­çš„æ‰€æœ‰èµ„æºæ²¡æœ‰å‘½åç©ºé—´çš„ç›¸å…³é…ç½®ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ </p></li><li><p>ç¦»çº¿æ–¹å¼è¿è¡Œgitlab-runneréœ€è¦é‡æ–°æŒ‡å®šæ‰§è¡Œå™¨çš„gitlab-runner-helperé•œåƒçš„ä½ç½® <code>image: gitlab/gitlab-runner:alpine-v13.4.1</code></p></li><li><p><code>serviceAccountName: your-service-account</code> éœ€è¦ä¿®æ”¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>bash</span>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=err>(</span><span class=p>...</span><span class=err>)</span>
</span></span><span class=line><span class=cl><span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>(</span><span class=p>...</span><span class=err>)</span>
</span></span><span class=line><span class=cl><span class=nx>helper_image</span> <span class=p>=</span> <span class=s2>&#34;my.registry.local/gitlab/gitlab-runner-helper:tag&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>å‚è€ƒhttps://www.cnblogs.com/wu-wu/p/13269950.html</p></li></ul></blockquote><h2 id=gitlab-runnerå®‰è£…å½“ä¸­éœ€è¦æ³¨æ„çš„é—®é¢˜>gitlab-runnerå®‰è£…å½“ä¸­éœ€è¦æ³¨æ„çš„é—®é¢˜</h2><p>æœ¬ç« èŠ‚è®°å½•ä»‹ç»å®‰è£…å½“ä¸­çš„å‘ä»¥åŠè§£å†³åŠæ³•</p><h3 id=kubernetesé›†ç¾¤æœ‰æ±¡ç‚¹å¯¼è‡´æ‰§è¡Œå™¨æ— æ³•å¯åŠ¨çš„é—®é¢˜åŠè§£å†³åŠæ³•>kubernetesé›†ç¾¤æœ‰æ±¡ç‚¹å¯¼è‡´æ‰§è¡Œå™¨æ— æ³•å¯åŠ¨çš„é—®é¢˜åŠè§£å†³åŠæ³•</h3><p>å› ä¸ºæœ¬æ¬¡ä½¿ç”¨çš„kubernetesçš„æœºå™¨ä¸­æœ‰æ±¡ç‚¹<code>taint</code>å¹¶ä¸”æ— æ³•åˆ é™¤ã€‚åœ¨æ— æ³•åˆ é™¤çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç»™æ‰§è¡Œå™¨å¯åŠ¨çš„posæ·»åŠ é»˜è®¤é…ç½®çš„æ±¡ç‚¹å®¹å¿ã€‚è¿™ä¸ªé—®é¢˜åªèƒ½é€šè¿‡ä¿®æ”¹gitlab-runnerçš„<code>config.toml</code>æ–‡ä»¶æ¥è§£å†³,helmå®‰è£…gitlab-runnerçš„é…ç½®æ–‡ä»¶<code>values.yaml</code>æ— æ³•è¿›è¡Œç›¸å…³é…ç½®ï¼Œå¹¶ä¸”å› ä¸ºä½¿ç”¨helmå®‰è£…çš„gitlab-runnerçš„é…ç½®æ–‡ä»¶<code>config.toml</code>æ˜¯é€šè¿‡<code>values.yaml</code>è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¯¼è‡´æ— æ³•æŒ‚è½½æ•°æ®å·è¿›è¡Œé…ç½®ã€‚</p><h4 id=è§£å†³æ–¹æ¡ˆ>è§£å†³æ–¹æ¡ˆ</h4><p>gitlab-runner å®¹å™¨å¯åŠ¨æ—¶ä¼šè¿è¡Œè„šæœ¬<code>/bin/bash /scripts/entrypoint</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>set</span> -e
</span></span><span class=line><span class=cl>mkdir -p /home/gitlab-runner/.gitlab-runner/
</span></span><span class=line><span class=cl>cp /scripts/config.toml /home/gitlab-runner/.gitlab-runner/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Register the runner</span>
</span></span><span class=line><span class=cl><span class=c1># ä¸­é—´éƒ¨åˆ†çœç•¥......</span>
</span></span><span class=line><span class=cl><span class=c1># Run pre-entrypoint-script</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! bash /scripts/pre-entrypoint-script<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=c1># å¢åŠ hostsåŸŸåè§£æ</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;9r /scripts/hosts&#39;</span> /home/gitlab-runner/.gitlab-runner/config.toml
</span></span><span class=line><span class=cl><span class=c1># å›ºå®šä¸»æœºè°ƒåº¦</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;38r /scripts/affinity.txt&#39;</span> /home/gitlab-runner/.gitlab-runner/config.toml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>           [[runners.kubernetes.volumes.host_path]]
</span></span></span><span class=line><span class=cl><span class=s>            name = &#34;gitlab-runner-cache&#34;
</span></span></span><span class=line><span class=cl><span class=s>            mount_path = &#34;/opt/cache&#34;
</span></span></span><span class=line><span class=cl><span class=s>            read_only = false
</span></span></span><span class=line><span class=cl><span class=s>            host_path = &#34;/data/gitlab-runner/cache&#34;
</span></span></span><span class=line><span class=cl><span class=s>            [[runners.kubernetes.volumes.host_path]]
</span></span></span><span class=line><span class=cl><span class=s>              name = &#34;docker&#34;
</span></span></span><span class=line><span class=cl><span class=s>              mount_path = &#34;/var/run/docker.sock&#34;
</span></span></span><span class=line><span class=cl><span class=s>              read_only = true
</span></span></span><span class=line><span class=cl><span class=s>              host_path = &#34;/var/run/docker.sock&#34;
</span></span></span><span class=line><span class=cl><span class=s>           [runners.kubernetes.node_tolerations]
</span></span></span><span class=line><span class=cl><span class=s>             &#34;cattle.io/os=linux&#34; = &#34;NoSchedule&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=c1># Start the runner</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> /entrypoint run --user<span class=o>=</span>gitlab-runner <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --working-directory<span class=o>=</span>/home/gitlab-runner
</span></span></code></pre></td></tr></table></div></div><p>è¯¥è„šæœ¬åœ¨gitlab-runnerç»‘å®šçš„é…ç½®æ˜ å°„ä¸­è¿›è¡Œé…ç½®ã€‚åœ¨è¯¥è„šæœ¬çš„æœ«å°¾è¿½åŠ ä»¥ä¸‹å†…å®¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>node_tolerations</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;cattle.io/os=linux&#34;</span> <span class=p>=</span> <span class=s2>&#34;NoSchedule&#34;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a class=link href=https://docs.gitlab.com/runner/executors/kubernetes.html#define-keywords-in-the-configuration-toml target=_blank rel=noopener>https://docs.gitlab.com/runner/executors/kubernetes.html#define-keywords-in-the-configuration-toml</a></p><p><a class=link href=https://gitlab.com/gitlab-org/gitlab-runner/-/issues/2578 target=_blank rel=noopener>https://gitlab.com/gitlab-org/gitlab-runner/-/issues/2578</a></p></blockquote><h3 id=å…³äºhelmå®‰è£…çš„gitlab-runneræ‰€å¯åŠ¨çš„æ‰§è¡Œå™¨ç»å¸¸å› ä¸ºcould-not-resolve-hostgitdomaincomæŠ¥é”™çš„é—®é¢˜>å…³äºHelmå®‰è£…çš„gitlab-runneræ‰€å¯åŠ¨çš„æ‰§è¡Œå™¨ç»å¸¸å› ä¸ºCould not resolve host:git.domain.comæŠ¥é”™çš„é—®é¢˜</h3><p>helmå®‰è£…çš„gitlab-runneræ‰€å¯åŠ¨çš„æ‰§è¡Œå™¨ä¸ºk8sä¸­çš„podã€‚ä¼šæœ‰podå®¹å™¨å†…æ— æ³•è§£ægitlabæ‰€dnsçš„åŸŸåçš„é—®é¢˜ï¼Œå¹¶ä¸”æ˜¯é—´æ­‡æ€§çš„ï¼Œ80%å·¦å³æ˜¯ä¼šè§£æä¸åˆ°çš„ã€‚å¹¶ä¸”è¿™äº›é…ç½®éœ€è¦ä¿®æ”¹<code>config.toml</code>ã€‚helmå®‰è£…çš„gitlab-runnerç›®å‰æ— æ³•ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚</p><p>ç›®å‰è§£å†³åŠæ³•åŒä¸Šï¼Œåœ¨é…ç½®æ˜ å°„çš„<code>entrypoint</code>è„šæœ¬çš„æœ«å°¾æ·»åŠ å‘½ä»¤<code>sed -i '9r /scripts/hosts' /home/gitlab-runner/.gitlab-runner/config.toml</code></p><p>hostsçš„å†…å®¹ä¸º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>pre_clone_script</span> <span class=p>=</span> <span class=s2>&#34;echo &#39;10.10.0.18 git.wx.com&#39; &gt;&gt; /etc/hosts&#34;</span>	
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a class=link href=https://gitlab.com/gitlab-org/gitlab-runner/-/issues/4129 target=_blank rel=noopener>https://gitlab.com/gitlab-org/gitlab-runner/-/issues/4129</a></p><p><a class=link href=https://gitlab.com/gitlab-org/charts/gitlab-runner/-/merge_requests/265 target=_blank rel=noopener>https://gitlab.com/gitlab-org/charts/gitlab-runner/-/merge_requests/265</a></p></blockquote><h3 id=åœ¨å®¹å™¨ä¸­æ„å»ºæ—¶ä½¿ç”¨docker>åœ¨å®¹å™¨ä¸­æ„å»ºæ—¶ä½¿ç”¨docker</h3><p>åœ¨å®¹å™¨ä¸­è¿›è¡Œæ„å»ºæ—¶å¦‚æœéœ€è¦ç”¨åˆ°dockeræ—¶ï¼Œç›®å‰é‡‡ç”¨çš„æ˜¯æ“çºµå®¿ä¸»æœºdockerçš„æ–¹å¼ï¼Œéœ€è¦ç»™runnerå¯åŠ¨çš„æ‰§è¡Œå™¨æŒ‚è½½æ•°æ®å·ï¼Œ<code>config.toml</code>é…ç½®æ–‡ä»¶ï¼Œåœ¨é…ç½®æ˜ å°„çš„<code>entrypoint</code>è„šæœ¬çš„æœ«å°¾è¿½åŠ </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>volumes</span><span class=p>.</span><span class=nx>host_path</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>mount_path</span> <span class=p>=</span> <span class=s2>&#34;/var/run/docker.sock&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>read_only</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>host_path</span> <span class=p>=</span> <span class=s2>&#34;/var/run/docker.sock&#34;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a class=link href=https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-in-your-builds target=_blank rel=noopener>https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-in-your-builds</a></p></blockquote><h3 id=ç¼“å­˜ç›¸å…³é…ç½®>ç¼“å­˜ç›¸å…³é…ç½®</h3><p>GitLab Runnerå¯¹ç¼“å­˜æ–¹æ¡ˆçš„æ”¯æŒæœ‰é™ï¼Œç›®å‰é‡‡ç”¨æŒ‚è½½Volumeçš„æ–¹å¼åšç¼“å­˜ã€‚å®‰è£…GitLab Runneræ—¶é»˜è®¤ä½¿ç”¨<code>/opt/cache</code>ç›®å½•ä½œä¸ºç¼“å­˜ç©ºé—´ã€‚æŒ‚è½½æ•°æ®å·å¹¶ä¸”ï¼Œé…ç½®ä¸»æœºè°ƒåº¦è‡³å›ºå®šèŠ‚ç‚¹ï¼ˆä»¥ä¸Šæ“ä½œéœ€è¦ä¿®æ”¹é…ç½®æ˜ å°„ä¸­çš„<code>entrypoint</code>æ–‡ä»¶ï¼Œ<code>entrypoint</code>æ–‡ä»¶è¯¦æƒ…è§ä¸Šé¢ï¼‰</p><p>é…ç½®å›ºå®šä¸»æœºèŠ‚ç‚¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=p>[</span><span class=l>runners.kubernetes.affinity.node_affinity]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>[[</span><span class=l>runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution]]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=l>weight = 100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>[</span><span class=l>runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution.preference]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>[[</span><span class=l>runners.kubernetes.affinity.node_affinity.preferred_during_scheduling_ignored_during_execution.preference.match_expressions]]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=l>key = &#34;kubernetes.io/hostname&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=l>operator = &#34;In&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=l>values = [&#34;rancher-node2&#34;]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æŒ‚è½½æ•°æ®å·</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>volumes</span><span class=p>.</span><span class=nx>host_path</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;gitlab-runner-cache&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>mount_path</span> <span class=p>=</span> <span class=s2>&#34;/opt/cache&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>read_only</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>host_path</span> <span class=p>=</span> <span class=s2>&#34;/data/gitlab-runner/cache&#34;</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>å‚è€ƒèµ„æ–™</p><p><a class=link href="https://help.aliyun.com/document_detail/106968.html?aly_as=b8lTvr8V" target=_blank rel=noopener>https://help.aliyun.com/document_detail/106968.html?aly_as=b8lTvr8V</a></p><p><a class=link href=https://blog.csdn.net/xichenguan/article/details/101439395 target=_blank rel=noopener>https://blog.csdn.net/xichenguan/article/details/101439395</a></p><p><a class=link href=https://www.cnblogs.com/5bug/p/12733755.html target=_blank rel=noopener>https://www.cnblogs.com/5bug/p/12733755.html</a></p></blockquote><h3 id=gitlab-runner-éƒ¨ç½²åˆ°k8sæ—¶æŠ¥é”™deploymentextensions-demo-is-forbidden-user-systemserviceaccountgitlabdefault-cannot-get-resource-deployments-in-api-group-extensions-in-the-namespace-default>gitlab-runner éƒ¨ç½²åˆ°k8sæ—¶æŠ¥é”™:deployment.extensions demo is forbidden: user &ldquo;system:serviceaccount:gitlab:default&rdquo; cannot get resource deployments in api group extensions in the namespace default</h3><p>åŸå› ä¸ºï¼šk8sä½¿ç”¨çš„RBACæƒé™è®¿é—®æ§åˆ¶ï¼Œå½“å‰å¯¹namespace default æ²¡æœ‰æ“ä½œæƒé™ã€‚é»˜è®¤å¯¹æ¯ä¸€ä¸ªå‘½åç©ºé—´æœ‰ä¸€ä¸ªé»˜è®¤çš„serviceaccount ï¼šdefault
<img src=https://img-blog.csdnimg.cn/2019092511311630.png loading=lazy alt=åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°>
å¦‚æœåœ¨CIé‡Œé¢æ²¡æœ‰ç‰¹åˆ«æŒ‡å®šserviceaccount é‚£ä¹ˆå°†ä½¿ç”¨é»˜è®¤è´¦æˆ· system:serviceaccount:gitlab:default
æœ€ç»ˆçš„åŸå› å°±æ˜¯æ²¡æœ‰åˆ›å»º å¯¹åº” namespaces çš„ é›†ç¾¤è§’è‰²ç»‘å®šclusterrolebinding
è§£å†³åŠæ³•ï¼š
æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºclusterrolebindingå³å¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create clusterrolebinding gitlab-cluster-admin --clusterrole<span class=o>=</span>cluster-admin --group<span class=o>=</span>system:serviceaccounts --namespace<span class=o>=</span>default
</span></span></code></pre></td></tr></table></div></div><h2 id=gitlab-cicd-çš„ä½¿ç”¨æ–‡æ¡£>GitLab CI/CD çš„ä½¿ç”¨æ–‡æ¡£</h2><p>ä¸ºäº†ä½¿ç”¨GitLab CI/CDï¼Œä½ éœ€è¦ä¸€ä¸ªæ‰˜ç®¡åœ¨GitLabä¸Šçš„åº”ç”¨ç¨‹åºä»£ç åº“ï¼Œå¹¶ä¸”åœ¨æ ¹ç›®å½•ä¸­çš„<code>.gitlab-ci.yml</code>æ–‡ä»¶ä¸­æŒ‡å®šæ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²çš„è„šæœ¬ã€‚</p><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥å®šä¹‰è¦è¿è¡Œçš„è„šæœ¬ï¼Œå®šä¹‰åŒ…å«çš„ä¾èµ–é¡¹ï¼Œé€‰æ‹©è¦æŒ‰é¡ºåºè¿è¡Œçš„å‘½ä»¤å’Œè¦å¹¶è¡Œè¿è¡Œçš„å‘½ä»¤ï¼Œå®šä¹‰è¦åœ¨ä½•å¤„éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œä»¥åŠæŒ‡å®šæ˜¯å¦ è¦è‡ªåŠ¨è¿è¡Œè„šæœ¬æˆ–æ‰‹åŠ¨è§¦å‘è„šæœ¬ã€‚</p><p>ä¸ºäº†å¯è§†åŒ–å¤„ç†è¿‡ç¨‹ï¼Œå‡è®¾æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰è„šæœ¬ä¸åœ¨è®¡ç®—æœºçš„ç»ˆç«¯ä¸Šè¿è¡Œçš„å‘½ä»¤ç›¸åŒã€‚</p><p>ä¸€æ—¦ä½ å·²ç»æ·»åŠ äº†<code>.gitlab-ci.yml</code>åˆ°ä»“åº“ä¸­ï¼ŒGitLabå°†æ£€æµ‹åˆ°è¯¥æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨åä¸ºGitLab Runnerçš„å·¥å…·è¿è¡Œä½ çš„è„šæœ¬ã€‚è¯¥å·¥å…·çš„æ“ä½œä¸ç»ˆç«¯ç±»ä¼¼ã€‚</p><p>è¿™äº›è„šæœ¬è¢«åˆ†ç»„åˆ°ä½œä¸šï¼ˆjobsï¼‰ï¼Œå®ƒä»¬å…±åŒç»„æˆä¸€ä¸ªæµæ°´çº¿ï¼ˆpipelineï¼‰ã€‚æµæ°´çº¿å°±æ˜¯ä¸€æ¬¡æ„å»ºçš„å®Œæ•´çš„æ‰§è¡Œæµç¨‹ã€‚</p><h3 id=gitlab-ciyml>.gitlab-ci.yml</h3><p>è¯¥æ–‡ä»¶è§„å®šäº†ä¸€ä¸ªæµæ°´çº¿(pipeline)ï¼Œæµæ°´çº¿ä¸­å¯ä»¥æœ‰å¤šä¸ªä½œä¸šï¼ˆjobï¼‰ï¼Œæ¯ä¸ªä½œä¸šå¿…é¡»å…·æœ‰å”¯ä¸€çš„åç§°ï¼ˆä¸èƒ½ä½¿ç”¨å…³é”®å­—ï¼‰ï¼Œæ¯ä¸ªä½œä¸šæ—¶ç‹¬ç«‹æ‰§è¡Œçš„ã€‚æ¯ä¸ªä½œä¸šè‡³å°‘åŒ…å«ä¸€ä¸ª<code>script</code>ã€‚</p><h4 id=job>job</h4><h5 id=before_script>before_script</h5><p>å®šä¹‰shellè„šæœ¬ï¼Œè¯¥è„šæœ¬åœ¨æ¯ä¸ªä½œä¸šä¹‹å‰è¿è¡Œã€‚è¯¥å…³é”®å­—ä¹Ÿå¯ä»¥å®šä¹‰åœ¨æ–‡ä»¶çš„å¼€å¤´ï¼Œä½œä¸ºå…¨å±€é»˜è®¤æ‰§è¡Œã€‚è¯¥å…³é”®å­—å®šä¹‰çš„è„šæœ¬å’Œ<code>script</code>å®šä¹‰çš„è„šæœ¬åœ¨ä¸€ä¸ªshellå½“ä¸­ä¸²è”æ‰§è¡Œï¼Œå¦‚æœå¤±è´¥å¯¼è‡´æ•´ä¸ªä½œä¸šçš„å¤±è´¥ï¼Œå…¶ä»–ä½œä¸šå°†ä¸å†æ‰§è¡Œã€‚ä½†æ˜¯ä½œä¸šå¤±è´¥ä¸ä¼šå½±å“<code>after_script</code>è¿è¡Œã€‚</p><h5 id=script>script</h5><p>æŒ‡å®šè¿è¡Œçš„shellè„šæœ¬ï¼Œæ¯ä¸ªä½œä¸šè‡³å°‘åŒ…å«ä¸€ä¸ª<code>script</code>ã€‚å¯ä»¥æ˜¯ä¸€æ¡å‘½ä»¤ä¹Ÿå¯ä»¥æ˜¯å¤šæ¡å‘½ä»¤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>job</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>unname -a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>bundle exec rspec</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>script</code>å‘½ä»¤å°†éœ€è¦ç”¨å•å¼•å·å’ŒåŒå¼•å·å¼•èµ·æ¥ã€‚ä¾‹å¦‚ï¼ŒåŒ…å«å†’å·å‘½ä»¤<code>:</code>éœ€è¦åŠ å¼•å·ï¼Œä»¥ä¾¿è¢«YAMLè§£æå™¨å½“ä½œå­—ç¬¦ä¸²æ¥è§£æã€‚è€Œä¸æ˜¯ä¸€ä¸ª<code>key: value</code>ã€‚éœ€è¦æ³¨æ„çš„ç‰¹æ®Šå­—ç¬¦æœ‰:<code>:</code>,<code>{ }</code>,<code>[ ]</code>,<code>,</code>,<code>&</code>,<code>*</code>,<code>#</code>,<code>?</code>,<code>|</code>,<code>-</code>,<code>&lt; ></code>,<code>=</code>,<code>!</code>,<code>%</code>,<code>@</code></p><h5 id=after_script>after_script</h5><p>å®šä¹‰ä½œä¸šä¹‹åè¿è¡Œçš„å‘½ä»¤ï¼ˆåŒ…æ‹¬å¤±è´¥çš„ä½œä¸šï¼‰ï¼ŒæŒ‡å®šè„šæœ¬åœ¨æ–°çš„shellä¸­æ‰§è¡Œï¼Œä¸<code>before_script</code>å’Œ<code>script</code>åˆ†å¼€ã€‚</p><h5 id=tags>tags</h5><p>ç”¨äºæŒ‡å®šä½œä¸šæ‰€è¿è¡Œçš„runnerã€‚ï¼ˆç»“åˆrunneré…ç½®çš„æ ‡ç­¾æ¥ä½¿ç”¨ï¼‰</p><h5 id=allow_failure>allow_failure</h5><p>å…è®¸ä½œä¸šå¤±è´¥ï¼Œé»˜è®¤å€¼ä¸º<code>false</code>ã€‚</p><h5 id=when>when</h5><p>æ§åˆ¶ä½œä¸šè¿è¡Œã€‚</p><ul><li><code>on_success</code> å‰é¢é˜¶æ®µä¸­çš„æ‰€æœ‰ä½œä¸šéƒ½æˆåŠŸæ—¶æ‰æ‰§è¡Œï¼Œé»˜è®¤å€¼ã€‚</li><li><code>on_failure</code>å‰é¢çš„é˜¶æ®µå‡ºç°å¤±è´¥æ—¶è¿è¡Œã€‚</li><li><code>always</code>æ€»æ˜¯æ‰§è¡Œã€‚</li><li><code>manual</code>æ‰‹åŠ¨æ‰§è¡Œã€‚</li><li><code>delayed</code>å»¶è¿Ÿæ‰§è¡Œä½œä¸šã€‚<code>start_in</code>æŒ‡å®šå»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰ã€‚</li></ul><h5 id=timeout>timeout</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=l>build.sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w> </span><span class=l>hours 30 minutes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>test</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=l>rspec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>3h 30m</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä½œä¸šçº§åˆ«çš„è¶…æ—¶å¯ä»¥è¦†ç›–é¡¹ç›®çº§åˆ«çš„è¶…æ—¶ï¼Œä½†ä¸èƒ½è¶…è¿‡runnerç‰¹å®šçš„è¶…æ—¶ã€‚</p><h5 id=onlyexcept>only&amp;except</h5><p>è¯¥å…³é”®å­—é€æ¸è¢«<code>rules</code>æ›¿ä»£</p><ul><li><code>only</code>å®šä¹‰æ„å»ºå“ªäº›åˆ†æ”¯æˆ–æ ‡ç­¾çš„æ—¶ä¼šæ‰§è¡Œçš„ä½œä¸šã€‚</li><li><code>except</code>å®šä¹‰æ„å»ºå“ªäº›åˆ†æ”¯æˆ–æ ‡ç­¾çš„æ—¶ä¸ä¼šæ‰§è¡Œçš„ä½œä¸šã€‚</li></ul><h5 id=rules>rules</h5><p>æ„å»ºè§„åˆ™ï¼Œrulesä¸èƒ½å’Œ<code>only</code>&<code>except</code>ç»„åˆä½¿ç”¨</p><p>å¯ç”¨è§„åˆ™</p><ul><li><p>if</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>domain</span><span class=p>:</span><span class=w> </span><span class=l>example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>condescan</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>codescan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tags</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;codescan&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sleep 5;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;$domain == &#39;example.com&#39;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>manual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>on_success</span><span class=w> </span><span class=c>## é»˜è®¤æ‰§è¡Œ</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚æœdomainçš„å€¼åŒ¹é…ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨è¿è¡Œã€‚</p><p>ä¸åŒ¹é…on_sucessã€‚</p><p>æ¡ä»¶åˆ¤æ–­ä»ä¸Šåˆ°ä¸‹ï¼ŒåŒ¹é…æˆåŠŸåˆ™ä¸ä¼šåˆ¤æ–­æ¥ä¸‹æ¥çš„ifã€‚</p><p>å¤šæ¡ä»¶åŒ¹é…å¯ä»¥ä½¿ç”¨ <code>&&</code> <code>||</code>ã€‚</p></li><li><p>changes ï¼ˆæŒ‡å®šæ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼‰</p><p>æ¥æ”¶ä¸€ä¸ªæ–‡ä»¶è·¯å¾„çš„æ•°ç»„ï¼ˆæŒ‡å®šä»£ç åº“æ ¹è·¯å¾„çš„ç›¸å¯¹è·¯å¾„ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>changes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>Jenkinsfile</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>exists (æŒ‡å®šæ–‡ä»¶å­˜åœ¨)</p></li></ul><h5 id=artifacts>artifacts</h5><p>ç¼–è¯‘æ—¶ç”Ÿæˆçš„æ–‡ä»¶ç»Ÿç§°ä¸ºgitlabçš„åˆ¶å“ï¼Œä½œä¸šå®Œæˆååˆ¶å“å°†è¢«å‘é€åˆ°gitlabï¼Œå¯åœ¨gitlab uiä¸­ä¸‹è½½ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>release</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mvn package -U</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ç”¨äºå†å’Œå¹¶è¯·æ±‚ UIä¸­å…¬å¼€ä½œä¸šåˆ¶å“ï¼Œæ¯ä¸ªåˆå¹¶è¯·æ±‚æœ€å¤šå…¬å¼€10ä¸ªä½œä¸šåˆ¶å“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expose_as</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;artifact 1&#39;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># é€šè¿‡nameæŒ‡å®šæ‰€åˆ›å»ºçš„åˆ¶å“çš„åç§°ã€‚é»˜è®¤åç§°ä¸ºartifacts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># name: &#34;$CI_JOB_NAME&#34; # ä½œä¸šåç§°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;$CI_COMMIT_REF_NAME&#34;</span><span class=w> </span><span class=c># åˆ†æ”¯åç§°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ä¿å­˜æ—¶é—´ï¼Œé»˜è®¤30å¤©</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>expire_in</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;10&#39;</span><span class=w> </span><span class=c># 10ç§’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># expire_in: &#39;3 week&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>target/*.jar</span><span class=w> </span><span class=c>## å¯ä»¥æ˜¯æ–‡ä»¶ä¹Ÿå¯ä»¥æ˜¯ç›®å½•ã€‚ä¹Ÿå¯ä»¥æ˜¯é€šé…ç¬¦</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=dependencies>dependencies</h5><p>è·å–åˆ¶å“ï¼Œå®šä¹‰è¦è·å–åˆ¶å“çš„åˆ—è¡¨ï¼Œåªèƒ½ä»å½“å‰é˜¶æ®µä¹‹å‰çš„é˜¶æ®µè·å–ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>unittest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dependencies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>build</span><span class=w> </span><span class=c># å®šä¹‰ä½œä¸šåç§°</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=extends>extends</h5><p>ç»§æ‰¿å¼•å…¥é…ç½®æ–‡ä»¶çš„ä½œä¸š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>include</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>project</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;cidevops/cddevops-gitlabci-service&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;job/build.yml&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.build</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>.build çš„å†…å®¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>$BUILD_SHELL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>ls</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=stages>stages</h4><p>ç”¨äºå®šä¹‰ä½œä¸šå¯ä»¥ä½¿ç”¨çš„é˜¶æ®µï¼Œå¹¶ä¸”æ˜¯å…¨å±€å®šä¹‰ã€‚åŒä¸€é˜¶æ®µçš„ä½œä¸šå¹¶è¡Œè¿è¡Œï¼Œä¸åŒé˜¶æ®µçš„ä½œä¸šé¡ºåºæ‰§è¡Œã€‚</p><h5 id=prepost><code>.pre</code>&<code>.post</code></h5><p><code>.pre</code>å’Œ<code>.post</code>æ— éœ€å®šä¹‰é»˜è®¤å­˜åœ¨çš„é˜¶æ®µï¼Œ<code>.pre</code>å§‹ç»ˆæ˜¯æ•´ä¸ªæµæ°´çº¿çš„ç¬¬ä¸€ä¸ªè¿è¡Œé˜¶æ®µã€‚<code>.post</code>å§‹ç»ˆæ˜¯æœ€åä¸€ä¸ªè¿è¡Œé˜¶æ®µã€‚ç”¨æˆ·å®šä¹‰çš„é˜¶æ®µéƒ½åœ¨ä¸¤è€…ä¹‹é—´è¿è¡Œã€‚</p><h4 id=stage>stage</h4><p>æŒ‡å®šjobæ‰€è¿è¡Œçš„é˜¶æ®µã€‚ä¾èµ–äºå…¨å±€å®šä¹‰çš„<code>stages</code>ã€‚å¹¶ä¸”åŒä¸€ä¸ª<code>stage</code>çš„ä½œä¸šå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚ï¼ˆåŒæ—¶è¿è¡Œéœ€è¦æ³¨æ„runneré…ç½®çš„æœ€å¤§åŒæ—¶è¿è¡Œæ•°ï¼‰</p><h4 id=variables>variables</h4><p>å®šä¹‰å˜é‡ï¼Œå¯ä»¥åœ¨å…¨å±€å®šä¹‰ã€‚ä¹Ÿå¯ä»¥åœ¨ä½œä¸šä¸­å®šä¹‰ã€‚</p><blockquote><p>.gitlab-ci.yml é¢„è®¾å˜é‡å‚è€ƒ</p><p><a class=link href=https://blog.csdn.net/github_35631540/article/details/107864258 target=_blank rel=noopener>https://blog.csdn.net/github_35631540/article/details/107864258</a></p></blockquote><p>å…³äºå˜é‡æ–¹é¢çš„å‘å’Œé—®é¢˜ <a class=link href=https://gitlab.com/gitlab-org/gitlab/-/issues/233289 target=_blank rel=noopener>https://gitlab.com/gitlab-org/gitlab/-/issues/233289</a></p><h4 id=workflow>workflow</h4><p>é¡¶çº§å…³é”®å­—ç”¨äºæ˜¯å¦åˆ›å»ºæ•´ä¸ªæµæ°´çº¿</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>domain</span><span class=p>:</span><span class=w> </span><span class=l>example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>workflow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;$domain == &#39;example.com&#39;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w> </span><span class=c>## å¯ä»¥è®¾ç½®ä¸ºalwaysæˆ–neverï¼Œé»˜è®¤å€¼ä¸ºalwaysã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>never</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=cache>cache</h4><p>å­˜å‚¨ç¼–è¯‘é¡¹ç›®æ‰€éœ€çš„è¿è¡Œæ—¶ä¾èµ–é¡¹ï¼ŒæŒ‡å®šé¡¹ç›®å·¥ä½œç©ºé—´ä¸­éœ€è¦åœ¨ä½œä¸šä¹‹é—´ç¼“å­˜çš„æ–‡æˆ–ç›®å½•ã€‚</p><p>å…¨å±€cacheå®šä¹‰åœ¨ä½œä¸šä¹‹å¤–ï¼Œé’ˆå¯¹æ‰€æœ‰ä½œä¸šç”Ÿæ•ˆï¼Œä½œä¸šä¸­å®šä¹‰çš„cacheä¼˜å…ˆçº§æ›´é«˜ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>my/files</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=l>echo &#34;hello&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># å¯ä»¥é…ç½®ç‰¹å®šåˆ†æ”¯çš„ç¼“å­˜ï¼Œä¸ºæ¯ä¸ªä¸åŒçš„ä½œä¸šé…ç½®cache:keyæ—¶ï¼Œä¼šä¸ºæ¯ä¸ªä½œä¸šåˆ†é…ç‹¬ç«‹çš„cacheã€‚keyå¯ä»¥ä½¿ç”¨ä»»ä½•é¢„å®šä¹‰çš„å˜é‡ï¼Œé»˜è®¤ä¸ºdefaultã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>target/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ç¼“å­˜ç­–ç•¥ï¼Œé»˜è®¤åœ¨æ‰§è¡Œä½œä¸šå¼€å§‹æ—¶ä¸‹è½½æ–‡ä»¶ï¼Œå¹¶åœ¨ç»“æŸæ—¶é‡æ–°ä¸Šä¼ æ–‡ä»¶ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policy</span><span class=p>:</span><span class=w> </span><span class=l>pull</span><span class=w> </span><span class=c># è·³è¿‡ä¸‹è½½æ­¥éª¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># policy: push # è·³è¿‡ä¸Šä¼ æ­¥éª¤</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=include>include</h4><ul><li><p>local</p><p>å¼•å…¥å¤–éƒ¨yamlæˆ–ymlæ–‡ä»¶ã€‚å¼•å…¥åŒä¸€ä»£ç åº“çš„æ–‡ä»¶ï¼Œä½¿ç”¨ç›¸å¯¹äºæ ¹ç›®å½•çš„è·¯å¾„è¿›è¡Œå¼•å…¥ï¼Œéœ€è¦ä¸é…ç½®æ–‡ä»¶åœ¨åŒä¸€åˆ†æ”¯ä¸Šã€‚ ï¼ˆå¦‚æœå¼•å…¥çš„é…ç½®æ–‡ä»¶å’ŒåŸæ–‡ä»¶æœ‰é‡å¤çš„éƒ¨åˆ†åˆ™é‡å¤çš„éƒ¨åˆ†ä¸ä¼šç”Ÿæ•ˆï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>include</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>local</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ci/localci.yml&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>file</p><p>å¼•å…¥å…¶ä»–é¡¹ç›®æŸä¸€åˆ†æ”¯çš„æ–‡ä»¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>include</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>project</span><span class=p>:</span><span class=w> </span><span class=l>demo/demo-java-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w> </span><span class=c># åˆ†æ”¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;.gitlab-ci.yml&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>template</p><p>å¼•å…¥å®˜æ–¹æä¾›çš„<a class=link href=https://gitlab.com/gitlab-org/gitlab/tree/master/lib/gitlab/ci/templates target=_blank rel=noopener>æ¨¡æ¿</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>include</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>template:Auto-DevOps.gitlab-ci.yml</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>remote</p><p>å¼•å…¥è¿œç¨‹é…ç½®ï¼Œé€šè¿‡http/httpså¼•å…¥ã€‚å¼•å…¥çš„æ–‡ä»¶å¿…é¡»å¯ä»¥é€šè¿‡getè¯·æ±‚å…¬å¼€è®¿é—®ï¼Œä¸æ”¯æŒèº«ä»½éªŒè¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>includeï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>remote</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://gitlab.com/awesome-project/raw/master.gitlab-ci-template.yml&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul><blockquote><p>è‡ªå®šä¹‰CIé…ç½®æ–‡ä»¶è·¯å¾„</p><p>é»˜è®¤æƒ…å†µä¸‹ä¼šåœ¨é¡¹ç›®çš„æ ¹ç›®å½•æŸ¥æ‰¾<code>.gitlab-ci.yml</code>æ–‡ä»¶ï¼Œå¯ä»¥æŒ‡å®šç›®å½•ï¼Œä¹ŸåŒ…æ‹¬é¡¹ç›®å¤–çš„ä½ç½®</p><ul><li>.gitlab-ci.yml #default</li><li>.my/path/.gitlab-ci.yml</li><li><a class=link href=http://example.com/generate/ci/config.yml target=_blank rel=noopener>http://example.com/generate/ci/config.yml</a></li><li>.gitlab-ci.yml@mygroup/another-project # æ–‡ä»¶å@é¡¹ç›®åç§°</li></ul></blockquote><h4 id=image>image</h4><p>æ‰§è¡Œå™¨ä¸ºdockeræˆ–k8sæ—¶ï¼Œé»˜è®¤åœ¨æ³¨å†Œrunnerçš„æ—¶å€™éœ€è¦å¡«å†™ä¸€ä¸ªåŸºç¡€é•œåƒã€‚å¦‚æœæŒ‡å®šäº†å…¨å±€imageåˆ™æ‰€æœ‰ä½œä¸šä½¿ç”¨æ­¤imageåˆ›å»ºå®¹å™¨å¹¶åœ¨å…¶ä¸­è¿è¡Œã€‚å¦‚æœå…¨å±€æœªæŒ‡å®šï¼Œåˆ™ä¼šæŸ¥çœ‹ä½œä¸šä¸­æ˜¯å¦æœ‰æŒ‡å®šï¼Œå¦‚æœæœ‰åˆ™æ­¤jobæŒ‰ç…§æŒ‡å®šé•œåƒåˆ›å»ºå®¹å™¨å¹¶è¿è¡Œï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é•œåƒã€‚</p><h4 id=services>services</h4><p>å·¥ä½œæœŸé—´å¯åŠ¨å¦ä¸€ä¸ªdockerå®¹å™¨ï¼Œå¹¶linkåˆ°imageå®šä¹‰çš„dockerå®¹å™¨ã€‚è¿™æ ·ä¸¤ä¸ªé•œåƒä¼šäº’é€šï¼ŒæœåŠ¡é•œåƒå¯ä»¥è¿è¡Œä»»ä½•åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯æœ€å¸¸è§çš„æ˜¯è¿è¡Œæ•°æ®åº“ï¼Œå¦‚mysqlã€‚</p><p>å¦‚æœåœ¨è¿è¡Œå•å…ƒæµ‹è¯•æ—¶éœ€è¦æ•°æ®åº“åˆ™å¯ä»¥æŒ‡å®šã€‚</p><h4 id=trigger>trigger</h4><p>è§¦å‘å™¨ã€‚å®šä¹‰å½“å‰jobæ‰§è¡Œå®Œæˆåè§¦å‘å…¶ä»–é¡¹ç›®çš„æµæ°´çº¿</p><p>æ³¨æ„ï¼Œè§¦å‘å™¨ä¸èƒ½ä½¿ç”¨å˜é‡</p><h4 id=environment>environment</h4><p>å¦‚æœåœ¨ä½œä¸šä¸­å®šä¹‰ç¯å¢ƒï¼Œåˆ™gitlabå¯ä»¥å»è¿½è¸ªã€‚å¯ä»¥åœ¨gitlab uiçš„è¿ç»´-ã€‹ç¯å¢ƒä¸­å»æŸ¥çœ‹ï¼Œå¦‚æœenvironmentæŒ‡å®šä¸”ä¸å­˜åœ¨è¯¥åç§°ä¸‹çš„ç¯å¢ƒï¼Œåˆ™å°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°ç¯å¢ƒã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>deployï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>stageï¼š deploy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;deploy&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w> </span><span class=c># ç¯å¢ƒåç§°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://example.com ç¯å¢ƒåœ°å€</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å®æˆ˜gitlab-cicd-è‡ªåŠ¨åŒ–éƒ¨ç½²æ¨é€åˆ°harbor>å®æˆ˜:GitLab CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²æ¨é€åˆ°Harbor</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>stages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>package</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>docker_build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># mavenæ‰“åŒ…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>package</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>maven:3.6.3-openjdk-11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>package</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>script</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>${PACKAGE}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>cp target/demo-0.0.1-SNAPSHOT.jar /opt/cache/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>only</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># å°†jaråŒ…buildä¸ºæ–°çš„é•œåƒå¹¶æ›´æ–°åˆ°k8sé›†ç¾¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>docker_build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=m>10.10.10.233</span><span class=l>/system/docker-kubectl:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>docker_build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>script</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>FULL_IMAGE_NAME=10.10.10.233/test/demo:0.0.1-${CI_PIPELINE_ID}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>mkdir -p ${BUILD_DIR}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>echo ${FULL_IMAGE_NAME}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>cp /opt/cache/demo-0.0.1-SNAPSHOT.jar ${BUILD_DIR}/app.jar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>cp Dockerfile ${BUILD_DIR}/Dockerfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>echo build $FULL_IMAGE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>docker build -t $FULL_IMAGE_NAME ./${BUILD_DIR}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>docker login 10.10.10.233 -u${HARBOR_USERNAME} -p${HARBOR_PASSWORD}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>docker push $FULL_IMAGE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sh ./apply_deployment.sh ${FULL_IMAGE_NAME}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>only</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># å®šä¹‰å˜é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>PACKAGE</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;mvn clean package -Dmaven.repo.local=/opt/cache/.m2/repository&#39;</span><span class=w> </span><span class=c># æ„å»ºå‘½ä»¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>BUILD_DIR</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;docker_build&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Dockerfile</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> 10.10.10.233/system/openjdk:11.0.5-jdk-stretch-tools-arthas</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> app.jar /opt/dubbo-app/app.jar<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /opt/dubbo-app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 20880</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> java -server <span class=si>${</span><span class=nv>JAVA_DEBUG_OPTS</span><span class=si>}</span> <span class=si>${</span><span class=nv>JAVA_OPTS</span><span class=si>}</span> <span class=si>${</span><span class=nv>JMX_OPTS</span><span class=si>}</span> <span class=si>${</span><span class=nv>JAVA_AGENT_OPTS</span><span class=si>}</span> -XX:+DisableExplicitGC -verbose:gc --add-opens<span class=o>=</span>java.base/java.lang<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.lang.invoke<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.math<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.math<span class=o>=</span>ALL-UNNAMED -Xlog:gc*:gc.log::filecount<span class=o>=</span>10,filesize<span class=o>=</span><span class=m>1048576</span> -jar app.jar<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>éƒ¨ç½²åˆ°k8sè„šæœ¬</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>mkdir -p /etc/deploy
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;YXBpVmV....&#39;</span> <span class=p>|</span>base64 -d &gt; /etc/deploy/config <span class=c1># å­—ç¬¦ä¸²å†…å®¹ä¸ºkubeconfigæ–‡ä»¶çš„base64ç¼–ç </span>
</span></span><span class=line><span class=cl>kubectl -n default get Deployment demo
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl> <span class=nb>echo</span> <span class=s2>&#34;å·¥ä½œè´Ÿè½½å­˜åœ¨ï¼Œæ›´æ–°è´Ÿè½½é•œåƒ&#34;</span>
</span></span><span class=line><span class=cl> kubectl <span class=nb>set</span> image --record<span class=o>=</span><span class=nb>true</span> Deployment/demo <span class=nv>demo</span><span class=o>=</span><span class=si>${</span><span class=nv>1</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl> <span class=nb>echo</span> <span class=s2>&#34;å·¥ä½œè´Ÿè½½ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å·¥ä½œè´Ÿè½½&#34;</span>
</span></span><span class=line><span class=cl> kubectl apply -f Service.yml
</span></span><span class=line><span class=cl> kubectl apply -f Deployment.yml
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>åœ¨gitlab-runnerçš„k8sæ‰§è¡Œå™¨å®¹å™¨å†…å¦‚æœè¦è®¿é—®k8sé›†ç¾¤æ—¶ï¼Œå¦‚æœç›´æ¥æŒ‚è½½æ•°æ®å·çš„æ–¹å¼æŒ‡å®šä½¿ç”¨ä¹‹å‰å®‰è£…k8sæ—¶ç”Ÿæˆçš„configé…ç½®æ–‡ä»¶ä¼šå­˜åœ¨é—´æ­‡æ€§è®¿é—®ä¸åˆ°k8sé›†ç¾¤çš„æƒ…å†µï¼ŒåŸå› æœªçŸ¥ã€‚</p><p>ä»¥ä¸Šè®¿é—®æ–¹å¼æ˜¯å°†configæ–‡ä»¶é€šè¿‡base64ç¼–ç åå†è§£ç åè®¿é—®çš„æ–¹å¼ã€‚</p><p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤è®²configæ–‡ä»¶ç¼–ç <code>echo $(cat ~/.kube/config | base64) | tr -d " "</code></p><p>å‚è€ƒhttps://help.aliyun.com/document_detail/106968.html?aly_as=b8lTvr8V</p></blockquote><h1 id=gitlab-cicdé›†æˆ-sonarqubeè´¨é‡å¹³å°>gitlab CI/CDé›†æˆ SonarQubeè´¨é‡å¹³å°</h1><p><strong>SonarQube</strong>ï¼ˆæ›¾ç”¨å<strong>Sonar</strong>ï¼ˆå£°çº³ï¼‰[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-1 target=_blank rel=noopener>1]</a>ï¼‰æ˜¯ä¸€ä¸ª<a class=link href=https://zh.wikipedia.org/wiki/%e5%bc%80%e6%ba%90 target=_blank rel=noopener>å¼€æº</a>çš„<a class=link href=https://zh.wikipedia.org/wiki/%e8%bd%af%e4%bb%b6%e8%b4%a8%e9%87%8f target=_blank rel=noopener>ä»£ç è´¨é‡</a>ç®¡ç†ç³»ç»Ÿã€‚</p><ul><li>æ”¯æŒè¶…è¿‡25ç§ç¼–ç¨‹è¯­è¨€[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-2 target=_blank rel=noopener>2]</a>ï¼š<a class=link href=https://zh.wikipedia.org/wiki/Java target=_blank rel=noopener>Java</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/C%e8%af%ad%e8%a8%80 target=_blank rel=noopener>C</a>/<a class=link href=https://zh.wikipedia.org/wiki/C%2B%2B target=_blank rel=noopener>C++</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/C%e2%99%af target=_blank rel=noopener>C#</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/PHP target=_blank rel=noopener>PHP</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/Apache_Flex target=_blank rel=noopener>Flex</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/Groovy target=_blank rel=noopener>Groovy</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/JavaScript target=_blank rel=noopener>JavaScript</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/Python target=_blank rel=noopener>Python</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/PL/SQL target=_blank rel=noopener>PL/SQL</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/COBOL target=_blank rel=noopener>COBOL</a>ç­‰ã€‚ï¼ˆä¸è¿‡æœ‰äº›æ˜¯<a class=link href=https://zh.wikipedia.org/wiki/%e5%95%86%e4%b8%9a%e8%bd%af%e4%bb%b6 target=_blank rel=noopener>å•†ä¸šè½¯ä»¶</a>æ’ä»¶ï¼‰</li><li>å¯ä»¥åœ¨Androidå¼€å‘ä¸­ä½¿ç”¨</li><li>æä¾›<a class=link href=https://zh.wikipedia.org/wiki/%e9%87%8d%e5%a4%8d%e4%bb%a3%e7%a0%81 target=_blank rel=noopener>é‡å¤ä»£ç </a>ã€<a class=link href=https://zh.wikipedia.org/wiki/%e4%bb%a3%e7%a0%81%e9%a3%8e%e6%a0%bc target=_blank rel=noopener>ç¼–ç æ ‡å‡†</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95 target=_blank rel=noopener>å•å…ƒæµ‹è¯•</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/%e4%bb%a3%e7%a2%bc%e8%a6%86%e8%93%8b%e7%8e%87 target=_blank rel=noopener>ä»£ç è¦†ç›–ç‡</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/%e5%be%aa%e7%92%b0%e8%a4%87%e9%9b%9c%e5%ba%a6 target=_blank rel=noopener>ä»£ç å¤æ‚åº¦</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/%e9%98%b2%e5%be%a1%e6%80%a7%e7%bc%96%e7%a8%8b target=_blank rel=noopener>æ½œåœ¨Bug</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/%e6%b3%a8%e9%87%8a_%28%e8%ae%a1%e7%ae%97%e6%9c%ba%e8%af%ad%e8%a8%80%29 target=_blank rel=noopener>æ³¨é‡Š</a>å’Œ<a class=link href=https://zh.wikipedia.org/wiki/%e8%bd%af%e4%bb%b6%e8%ae%be%e8%ae%a1 target=_blank rel=noopener>è½¯ä»¶è®¾è®¡</a>æŠ¥å‘Š[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-methodsandtools-3 target=_blank rel=noopener>3]</a>[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-sonarinaction-4 target=_blank rel=noopener>4]</a></li><li>æä¾›äº†æŒ‡æ ‡å†å²è®°å½•ã€è®¡åˆ’å›¾ï¼ˆâ€œæ—¶é—´æœºå™¨â€ï¼‰å’Œå¾®åˆ†æŸ¥çœ‹</li><li>æä¾›äº†å®Œå…¨è‡ªåŠ¨åŒ–çš„åˆ†æï¼šä¸<a class=link href=https://zh.wikipedia.org/wiki/Apache_Maven target=_blank rel=noopener>Maven</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/Apache_Ant target=_blank rel=noopener>Ant</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/Gradle target=_blank rel=noopener>Gradle</a>å’Œ<a class=link href=https://zh.wikipedia.org/wiki/%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90 target=_blank rel=noopener>æŒç»­é›†æˆ</a>å·¥å…·ï¼ˆ<a class=link href="https://zh.wikipedia.org/w/index.php?title=Atlassian_Bamboo&amp;action=edit&amp;redlink=1" target=_blank rel=noopener>Atlassian Bamboo</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/Jenkins_%28%e8%bd%af%e4%bb%b6%29 target=_blank rel=noopener>Jenkins</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/Hudson_%28%e8%bd%af%e4%bb%b6%29 target=_blank rel=noopener>Hudson</a>ç­‰ï¼‰[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-jteam-5 target=_blank rel=noopener>5]</a>[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-g3global-6 target=_blank rel=noopener>6]</a>[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-slideshare-7 target=_blank rel=noopener>7]</a></li><li>ä¸<a class=link href=https://zh.wikipedia.org/wiki/Eclipse target=_blank rel=noopener>Eclipse</a>å¼€å‘ç¯å¢ƒé›†æˆ</li><li>ä¸<a class=link href=https://zh.wikipedia.org/wiki/JIRA target=_blank rel=noopener>JIRA</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/Mantis target=_blank rel=noopener>Mantis</a>ã€<a class=link href=https://zh.wikipedia.org/wiki/LDAP target=_blank rel=noopener>LDAP</a>ã€<a class=link href="https://zh.wikipedia.org/w/index.php?title=Fortify&amp;action=edit&amp;redlink=1" target=_blank rel=noopener>Fortify</a>ç­‰å¤–éƒ¨å·¥å…·é›†</li><li>æ”¯æŒæ‰©å±•æ’ä»¶[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-zauber-8 target=_blank rel=noopener>8]</a>[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-infoq-9 target=_blank rel=noopener>9]</a></li><li>åˆ©ç”¨<a class=link href="https://zh.wikipedia.org/w/index.php?title=SQALE&amp;action=edit&amp;redlink=1" target=_blank rel=noopener>SQALE</a>è®¡ç®—<a class=link href=https://zh.wikipedia.org/wiki/%e6%8a%80%e6%9c%af%e5%80%ba%e5%8a%a1 target=_blank rel=noopener>æŠ€æœ¯å€ºåŠ¡</a>[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-10 target=_blank rel=noopener>10]</a></li><li>æ”¯æŒ<a class=link href=https://zh.wikipedia.org/wiki/Apache_Tomcat target=_blank rel=noopener>Tomcat</a>ã€‚ä¸è¿‡è®¡åˆ’ä»SonarQube 4.1èµ·ç»ˆæ­¢å¯¹Tomcatçš„æ”¯æŒ[<a class=link href=https://zh.wikipedia.org/wiki/SonarQube#cite_note-11 target=_blank rel=noopener>11]</a>ã€‚</li></ul><h2 id=sonarqubeçš„å®‰è£…>SonarQubeçš„å®‰è£…</h2><p>SonarQubeéœ€è¦ä¾èµ–Postgresqlæ•°æ®åº“ï¼Œéƒ½ä½¿ç”¨dockerè¿›è¡Œå®‰è£…</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># åˆ›å»ºæ•°æ®å·ç›¸å…³çš„ç›®å½•</span>
</span></span><span class=line><span class=cl>mkdir -p /data/postgresql/data
</span></span><span class=line><span class=cl>mkdir -p /var/lib/postgresql
</span></span><span class=line><span class=cl>ln -s /data/postgresql/data/ /var/lib/postgresql/data
</span></span><span class=line><span class=cl><span class=c1># è¿è¡Œé•œåƒ</span>
</span></span><span class=line><span class=cl>docker run --name postgresql -p 5432:5432 -e <span class=nv>POSTGRES_USER</span><span class=o>=</span>sonar -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>sonar -e <span class=nv>POSTGRE_DB</span><span class=o>=</span>sonar -v /data/postgresql/data:/var/lib/postgresql/data -d postgres
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºæ•°æ®å·ç›¸å…³çš„ç›®å½•</span>
</span></span><span class=line><span class=cl>mkdir -p /data/sonarqube/data
</span></span><span class=line><span class=cl>mkdir -p /data/sonarqube/extensions
</span></span><span class=line><span class=cl>mkdir -p /data/sonarqube/logs
</span></span><span class=line><span class=cl>mkdir -p /opt/sonarqube/extensions/plugins
</span></span><span class=line><span class=cl>chmod -R <span class=m>777</span> /data/sonarqube/
</span></span><span class=line><span class=cl>chmod -R <span class=m>777</span> /opt/sonarqube/
</span></span><span class=line><span class=cl>ln -s /data/sonarqube /opt/sonarqube
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¿è¡Œé•œåƒ</span>
</span></span><span class=line><span class=cl>docker run --name sonarqube <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--link postgresql <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-e <span class=nv>SONARQUBE_JDBC_URL</span><span class=o>=</span>jdbc:postgresql://postgresql:5432/sonar <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-e <span class=nv>SONAR_JDBC_USERNAME</span><span class=o>=</span>sonar <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-e <span class=nv>SONAR_JDBC_PASSWORD</span><span class=o>=</span>sonar <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-p 9000:9000 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-v /data/sonarqube/data:/opt/sonarqube/data <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-v /data/sonarqube/extensions:/opt/sonarqube/extensions <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-v /data/sonarqube/logs:/opt/sonarqube/logs <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>sonarqube
</span></span></code></pre></td></tr></table></div></div><blockquote><p>dockeré•œåƒå¯åŠ¨æŠ¥é”™ï¼šElasticsearch: Max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</p><p>åœ¨é•œåƒå¯åŠ¨çš„ç‰©ç†æœºè¿è¡Œå¦‚ä¸‹å‘½ä»¤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sysctl -w vm.max_map_count<span class=o>=</span><span class=m>262144</span>
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://stackoverflow.com/questions/51445846/elasticsearch-max-virtual-memory-areas-vm-max-map-count-65530-is-too-low-inc target=_blank rel=noopener>å‚è€ƒè‡ªStackOverflow</a></p></blockquote><h2 id=sonarqubeæ•´åˆgitlab-cicd-åˆ†æjavaä»£ç >SonarQubeæ•´åˆgitlab CI/CD åˆ†æJavaä»£ç </h2><p>è¯¥åˆ†æåŸºäºsonar-scannerçš„mavenæ’ä»¶ã€‚</p><p><strong>å…¨å±€é…ç½®</strong></p><p>é¦–å…ˆä¿®æ”¹mavençš„å…¨å±€é…ç½®æ–‡ä»¶<code>settings.xml</code>ï¼Œæ·»åŠ ä¸‹å›¾ç¤ºä¾‹å†…å®¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;settings&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;pluginGroups&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;pluginGroup&gt;</span>org.sonarsource.scanner.maven<span class=nt>&lt;/pluginGroup&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/pluginGroups&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;profiles&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;profile&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;id&gt;</span>sonar<span class=nt>&lt;/id&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;activation&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;activeByDefault&gt;</span>true<span class=nt>&lt;/activeByDefault&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/activation&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;properties&gt;</span>
</span></span><span class=line><span class=cl>                <span class=c>&lt;!-- Optional URL to server. Default value is http://localhost:9000 --&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;sonar.host.url&gt;</span>
</span></span><span class=line><span class=cl>                  http://myserver:9000
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/sonar.host.url&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/properties&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/profile&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;/profiles&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/settings&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>åˆ†æ</strong></p><p>éœ€è¦åœ¨<code>.gitlab-ci.yml</code>æ·»åŠ å¦‚ä¸‹<code>stage</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>code_analysis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>maven:3.6.3-openjdk-11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>code_analysis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>  mvn clean verify sonar:sonar \
</span></span></span><span class=line><span class=cl><span class=sd>  -Dsonar.projectKey=${CI_PROJECT_NAME} \
</span></span></span><span class=line><span class=cl><span class=sd>  -Dsonar.host.url=http://10.10.10.236:31548 \
</span></span></span><span class=line><span class=cl><span class=sd>  -Dsonar.login=username \
</span></span></span><span class=line><span class=cl><span class=sd>  -Dsonar.password=password \
</span></span></span><span class=line><span class=cl><span class=sd>  -Dmaven.repo.local=/opt/cache/.m2/repository \
</span></span></span><span class=line><span class=cl><span class=sd>  --settings /opt/cache/settings.xml</span><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><p>å‚è€ƒè‡ª<a class=link href=https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-maven/ target=_blank rel=noopener>å®˜æ–¹æ–‡æ¡£</a></p><h2 id=åœ¨gitlab-cicdä½¿ç”¨å½“ä¸­é‡åˆ°çš„é—®é¢˜>åœ¨gitlab CI/CDä½¿ç”¨å½“ä¸­é‡åˆ°çš„é—®é¢˜</h2><h3 id=triggerè§¦å‘å™¨ä¸èƒ½ä½¿ç”¨å˜é‡å»å®šä¹‰>triggerè§¦å‘å™¨ä¸èƒ½ä½¿ç”¨å˜é‡å»å®šä¹‰</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># ä½¿ç”¨å˜é‡å»å¡«å……æ˜¯ä¸è¡Œçš„ï¼Œåªèƒ½ç›´æ¥å†™æ­»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server-deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>server-deploy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>trigger</span><span class=p>:</span><span class=w> </span><span class=l>${TEST}/${TEST}-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>only</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ç›´æ¥å†™æ­»æ‰èƒ½æ­£ç¡®è§¦å‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>server-deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>server-deploy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>trigger</span><span class=p>:</span><span class=w> </span><span class=l>ndp/foo-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>only</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=l>master</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=åœ¨åŒä¸€ä¸ªæµæ°´çº¿å½“ä¸­çš„jobä¹‹é—´å˜é‡æ— æ³•ä¼ é€’>åœ¨åŒä¸€ä¸ªæµæ°´çº¿å½“ä¸­çš„jobä¹‹é—´å˜é‡æ— æ³•ä¼ é€’</h3><p>è§£å†³æ–¹æ³•å‚è€ƒå¦‚ä¸‹</p><p><a class=link href=https://gitlab.com/gitlab-org/gitlab/-/issues/233289 target=_blank rel=noopener>https://gitlab.com/gitlab-org/gitlab/-/issues/233289</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/ci/cd/>CI/CD</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>æœ€åæ›´æ–°äº Nov 24, 2020 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/jenkins-restful-api/><div class=article-details><h2 class=article-title>Jenkins REST APIä»‹ç»</h2></div></a></article><article><a href=/p/spring-boot/><div class=article-details><h2 class=article-title>Spring Bootåº”ç”¨å‡æ­»ç°è±¡ï¼šSLF4Jæ—¥å¿—æ¡†æ¶å†²çªæ·±åº¦åˆ†æ</h2></div></a></article><article><a href=/p/database-index/><div class=article-details><h2 class=article-title>MySQL InnoDB ç´¢å¼•æœºåˆ¶ä¸ä¼˜åŒ–</h2></div></a></article><article><a href=/p/jmm/><div class=article-details><h2 class=article-title>JMM</h2></div></a></article><article><a href=/p/consistent-hash/><div class=article-details><h2 class=article-title>ä¸€è‡´æ€§å“ˆå¸Œçš„ç®€å•ä»‹ç»</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//majiang.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 ä»¿ç”Ÿäººä¼šæ¢¦è§ç”µå­ç¾Šå—ï¼Ÿ</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>